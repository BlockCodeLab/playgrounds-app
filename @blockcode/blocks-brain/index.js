import{getUserConfig as s,setUserConfig as c}from"@blockcode/utils";import{addLocalesMessages as v,openPromptModal as z,Text as i}from"@blockcode/core";import{fetchSpark as w,getUserConfig as d}from"@blockcode/utils";var _=4,O="https://spark-api-open.xf-yun.com/v1/chat/completions",C="qQIJHdBFkpbHDoMnPqnW:oeanHZdXCBHIHTOYvVim",N="db45f79e",R="MWFiNjVmNDA4YjNhODFkZGE0MGQ1YWRj",g="6a3dfe79b9e9ec588ca65bf3b9d9c847",L=(o=C)=>({"Content-Type":"application/json",Authorization:`Bearer ${o}`}),D=(o,e={})=>({model:e.model??"lite",user:e.user??"default",messages:o,temperature:0.4,top_k:3,max_tokens:30,stream:!1});function k(o){return{get key(){return"brain"},getHistory(e){return o.getData(`brain.${e.id()}.history`)??[]},addHistory(e,a){let t=this.getHistory(e);if(t.push(a),t.length>_)t.shift();o.setData(`brain.${e.id()}.history`,t)},getPrompts(e){return o.getData(`brain.${e.id()}.prompts`)??[]},addPrompt(e,a){let t=this.getPrompts(e);t.push(a),o.setData(`brain.${e.id()}.prompts`,t)},clear(e){o.setData(`brain.${e.id()}.history`,null),o.setData(`brain.${e.id()}.prompts`,null),o.setData(`brain.${e.id()}.result`,null)},getAnswer(e){return o.getData(`brain.${e.id()}.result`)??""},async askSpark(e,a,t="lite"){let b=d("SparkAI.APIPassword")??C,A=d("SparkAI.APPID")??N,T=d("SparkAI.APISecret")??R,S=d("SparkAI.APIKey")??g,f=e.id();this.addHistory(e,{role:"user",content:a});let M=this.getPrompts(e),E=[].concat({role:"system",content:`${M.join("；")}，只用一句话完成对话。`},this.getHistory(e)),n;try{n=await w(O,{method:"POST",mode:"no-cors",headers:L(b),body:JSON.stringify(D(E,{model:t,user:f})),auth:{appId:A,apiSecret:T,apiKey:S}}),n=await n.json()}catch(y){console.error(y)}if(n?.choices?.[0]?.message?.content)this.addHistory(e,n.choices[0].message),o.setData(`brain.${f}.result`,n.choices[0].message.content)}}}import{getUserConfig as P}from"@blockcode/utils";import{Text as l}from"@blockcode/core";import{jsx as p}from"preact/jsx-runtime";var u=[{id:"addPrompt",text:p(l,{id:"blocks.brain.addPrompt",defaultMessage:"add [PROMPT] prompt to Brain"}),inputs:{PROMPT:{type:"string",defaultValue:p(l,{id:"blocks.brain.prompt",defaultMessage:"your role is a cat"})}},emu(o){let e="";if(this.STATEMENT_PREFIX)e+=this.injectId(this.STATEMENT_PREFIX,o);let a=this.valueToCode(o,"PROMPT",this.ORDER_NONE)||"";return e+=`runtime.extensions.brain.addPrompt(target, ${a});
`,e},mpy(o){let e="";if(this.STATEMENT_PREFIX)e+=this.injectId(this.STATEMENT_PREFIX,o);let a=this.valueToCode(o,"PROMPT",this.ORDER_NONE)||"";return e+=`brain.set_prompt(target, ${a})
`,e}},{id:"askQuestion",text:p(l,{id:"blocks.brain.askQuestion",defaultMessage:"ask Brain [QUESTION] and wait"}),inputs:{QUESTION:{type:"string",defaultValue:p(l,{id:"blocks.brain.question",defaultMessage:"Who are you?"})}},emu(o){let e="";if(this.STATEMENT_PREFIX)e+=this.injectId(this.STATEMENT_PREFIX,o);let a=this.valueToCode(o,"QUESTION",this.ORDER_NONE)||'""';return e+=`await runtime.extensions.brain.askSpark(target, ${a})
`,e},mpy(o){let e=P("SparkAI.Model")??"lite",a=P("SparkAI.APIPassword")??C,t="";if(this.STATEMENT_PREFIX)t+=this.injectId(this.STATEMENT_PREFIX,o);let b=this.valueToCode(o,"QUESTION",this.ORDER_NONE)||'""';return t+=`await brain.ask_spark(target, ${b}, '${a}', '${e}')
`,t}},{id:"answer",text:p(l,{id:"blocks.brain.answer",defaultMessage:"answer"}),output:"string",emu(){return["runtime.extensions.brain.getAnswer(target)",this.ORDER_FUNCTION_CALL]},mpy(){return["brain.get_answer(target)",this.ORDER_FUNCTION_CALL]}},"---",{id:"clearPrompt",text:p(l,{id:"blocks.brain.clearHistory",defaultMessage:"delete all history"}),emu(o){let e="";if(this.STATEMENT_PREFIX)e+=this.injectId(this.STATEMENT_PREFIX,o);return e+=`runtime.extensions.brain.clear(target);
`,e},mpy(o){let e="";if(this.STATEMENT_PREFIX)e+=this.injectId(this.STATEMENT_PREFIX,o);return e+=`brain.clear(target)
`,e}}];var m={en:{"blocks.brain.name":"Brain","blocks.brain.openplatform":"iFLYTEK Open Platform authorization","blocks.brain.openplatform.APIPassword":"HTTP authorization APIPassword","blocks.brain.openplatform.APPID":"WebSocket authorization APPID","blocks.brain.openplatform.APISecret":"WebSocket authorization APISecret","blocks.brain.openplatform.APIKey":"WebSocket authorization APIKey","blocks.brain.openplatform.description1":"Please register your own ","blocks.brain.openplatform.description2":"iFLYTEK Open Platform (Chinese)","blocks.brain.openplatform.description3":" account, the test account we provide does not guarantee that every request will be successful.","blocks.brain.addPrompt":"add prompt [PROMPT] to Brain","blocks.brain.prompt":"dialogue with the character of a cat","blocks.brain.clearHistory":"delete prompts and result","blocks.brain.askQuestion":"ask Brain [QUESTION] and wait","blocks.brain.question":"hello","blocks.brain.answer":"answer"},"zh-Hans":{"blocks.brain.name":"智脑","blocks.brain.openplatform":"讯飞开放平台认证信息","blocks.brain.openplatform.APIPassword":"HTTP 服务鉴权 APIPassword","blocks.brain.openplatform.APPID":"WebSocket 服务鉴权 APPID","blocks.brain.openplatform.APISecret":"WebSocket 服务鉴权 APISecret","blocks.brain.openplatform.APIKey":"WebSocket 服务鉴权 APIKey","blocks.brain.openplatform.description1":"请注册您自己的","blocks.brain.openplatform.description2":"讯飞开放平台","blocks.brain.openplatform.description3":"账号，我们提供的测试账号不保证每次请求都成功。","blocks.brain.addPrompt":"将指令说明 [PROMPT] 加入智脑","blocks.brain.prompt":"用一只猫的性格对话","blocks.brain.clearHistory":"删除指令和结果","blocks.brain.askQuestion":"询问智脑 [QUESTION] 并等待","blocks.brain.question":"你好","blocks.brain.answer":"回答"},"zh-Hant":{"blocks.brain.name":"智腦","blocks.brain.openplatform":"訊飛開放平台認證信息","blocks.brain.openplatform.APIPassword":"HTTP 服務鑒權 APIPassword","blocks.brain.openplatform.APPID":"WebSocket 服務鑒權 APPID","blocks.brain.openplatform.APISecret":"WebSocket 服務鑒權 APISecret","blocks.brain.openplatform.APIKey":"WebSocket 服務鑒權 APIKey","blocks.brain.openplatform.description1":"請註冊您自己的","blocks.brain.openplatform.description2":"訊飛開放平台","blocks.brain.openplatform.description3":"賬號，我們提供的測試賬號不保證每次請求都成功。","blocks.brain.addPrompt":"將指令說明 [PROMPT] 加入智腦","blocks.brain.prompt":"用一隻貓的性格對話","blocks.brain.clearHistory":"刪除指令和結果","blocks.brain.askQuestion":"詢問智腦 [QUESTION] 並等待","blocks.brain.question":"你好","blocks.brain.answer":"回答"}};var I="./assets/icon-xdp12efg.svg";var h="./assets/brain-8ej092q6.py";import{jsx as r,jsxs as W,Fragment as H}from"preact/jsx-runtime";v(m);var r1={icon:I,name:r(i,{id:"blocks.brain.name",defaultMessage:"Brain"}),files:[{name:"brain",type:"text/x-python",uri:h}],statusButton:{onClick(){return new Promise((o)=>{z({title:r(i,{id:"blocks.brain.name",defaultMessage:"Brain"}),label:r(i,{id:"blocks.brain.name",defaultMessage:"Brain"}),inputItems:[{name:"apipassword",label:r(i,{id:"blocks.brain.openplatform.APIPassword",defaultMessage:"HTTP authorization APIPassword"}),placeholder:"APIPassword",defaultValue:s("SparkAI.APIPassword")??""},{name:"appid",label:r(i,{id:"blocks.brain.openplatform.APPID",defaultMessage:"WebSocket authorization APPID"}),placeholder:"APPID",defaultValue:s("SparkAI.APPID")??""},{name:"apisecret",label:r(i,{id:"blocks.brain.openplatform.APISecret",defaultMessage:"WebSocket authorization APISecret"}),placeholder:"APISecret",defaultValue:s("SparkAI.APISecret")??""},{name:"apikey",label:r(i,{id:"blocks.brain.openplatform.APIKey",defaultMessage:"WebSocket authorization APIKey"}),placeholder:"APIKey",defaultValue:s("SparkAI.APIKey")??""}],body:W(H,{children:[r(i,{id:"blocks.brain.openplatform.description1",defaultMessage:"Please register your own "}),r("a",{href:"https://xinghuo.xfyun.cn/sparkapi",target:"_blank",children:r(i,{id:"blocks.brain.openplatform.description2",defaultMessage:"iFLYTEK Open Platform (Chinese)"})}),r(i,{id:"blocks.brain.openplatform.description3",defaultMessage:" account, the test account we provide does not guarantee that every request will be successful."})]}),onSubmit:(e)=>{c("SparkAI.APIPassword",e.apipassword??""),c("SparkAI.APPID",e.appid??""),c("SparkAI.APISecret",e.apisecret??""),c("SparkAI.APIKey",e.apikey??""),o()}})})},onStatusUpdate(){let o=s("SparkAI.APIPassword"),e=s("SparkAI.APPID"),a=s("SparkAI.APISecret"),t=s("SparkAI.APIKey");return o||e&&a&&t}},emulator:k,blocks:u};export{r1 as default};
