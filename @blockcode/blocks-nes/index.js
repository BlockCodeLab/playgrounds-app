import{nanoid as k}from"@blockcode/utils";import{addLocalesMessages as w,setAlert as i,delAlert as b,Text as d,Spinner as h}from"@blockcode/core";import{MPYUtils as a}from"@blockcode/board";var M={en:{"blocks.nes.name":"NES emulator","blocks.nes.download":"Download ROM to Arcade"},"zh-Hans":{"blocks.nes.name":"NES 模拟器","blocks.nes.download":"下载 ROM 到游戏机"},"zh-Hant":{"blocks.nes.name":"NES 模擬器","blocks.nes.download":"下載 ROM 到遊戲機"}};var u="./assets/icon-jj2v9ggp.png";import{jsx as l}from"preact/jsx-runtime";w(M);var n,I=[{usbVendorId:12346,usbProductId:32769}],f=()=>{b(n),n=null},x=(o)=>{if(!n)n=k();if(o<100)i({id:n,icon:l(h,{level:"success"}),message:l(d,{id:"arcade.alert.downloading",defaultMessage:"Downloading...{progress}%",progress:o})});else i("downloadCompleted",{id:n}),setTimeout(f,2000)},s=(o)=>{if(o==="NotFoundError")return;i("connectionError",1000)},e,N={icon:u,name:l(d,{id:"blocks.nes.name",defaultMessage:"NES emulator"}),blocks:[{button:"DOWNLOAD_ROM",text:l(d,{id:"blocks.nes.download",defaultMessage:"Download ROM to Arcade"}),async onClick(){if(n)return;a.disconnect(e);try{e=await a.connect(I)}catch(r){s(r.name),e=null}if(!e)return;let o=a.check(e).catch(()=>{s(),f()}),t=document.createElement("input");t.type="file",t.accept=".nes",t.multiple=!0,t.click(),t.addEventListener("change",async({target:r})=>{let m=[],p="";for(let c of r.files)m.push({id:`nes/${c.name}`,content:await c.arrayBuffer()}),p=c.name;try{await a.write(e,m,x),await a.config(e,{"latest-game":p}),e.hardReset()}catch(c){s(c.name),f()}finally{o.cancel()}})}}]};export{N as default};
