import{nanoid as k}from"@blockcode/utils";import{addLocalesMessages as w,setAlert as s,delAlert as b,Text as i,Spinner as h}from"@blockcode/core";import{MPYUtils as a}from"@blockcode/board";var f={en:{"blocks.nes.name":"NES emulator","blocks.nes.download":"Download ROM to Arcade"},"zh-Hans":{"blocks.nes.name":"NES 模拟器","blocks.nes.download":"下载 ROM 到游戏机"},"zh-Hant":{"blocks.nes.name":"NES 模擬器","blocks.nes.download":"下載 ROM 到遊戲機"}};var p="./assets/icon-jj2v9ggp.png";import{jsx as c}from"preact/jsx-runtime";w(f);var o,I=[{usbVendorId:12346,usbProductId:32769}],d=()=>{b(o),o=null},x=(e)=>{if(!o)o=k();if(e<100)s({id:o,icon:c(h,{level:"success"}),message:c(i,{id:"gui.alert.downloadingProgress",defaultMessage:"Downloading...{progress}%",progress:e})});else s("downloadCompleted",{id:o}),setTimeout(d,2000)},l=(e)=>{if(e==="NotFoundError")return;s("connectionError",1000)},N={icon:p,name:c(i,{id:"blocks.nes.name",defaultMessage:"NES emulator"}),blocks:[{button:"DOWNLOAD_ROM",text:c(i,{id:"blocks.nes.download",defaultMessage:"Download ROM to Arcade"}),async onClick(){if(o)return;let e;try{e=await a.connect(I),await a.enterDownloadMode(e)}catch(r){l(r.name)}if(!e)return;let u=a.check(e).catch(()=>{l(),d()}),n=document.createElement("input");n.type="file",n.accept=".nes",n.multiple=!0,n.click(),n.addEventListener("change",async({target:r})=>{let m=[],M="";for(let t of r.files)m.push({id:`nes/${t.name}`,content:await t.arrayBuffer()}),M=t.name;try{await a.write(e,m,x),await a.config(e,{"latest-game":M}),e.hardReset()}catch(t){l(t.name),d()}u.cancel()})}}]};export{N as default};
