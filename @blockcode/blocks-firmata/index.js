import{addLocalesMessages as C0,Text as B0}from"@blockcode/core";var r=typeof Reflect=="object"?Reflect:null,c=r&&typeof r.apply=="function"?r.apply:function(F,E,C){return Function.prototype.apply.call(F,E,C)},l;r&&typeof r.ownKeys=="function"?l=r.ownKeys:Object.getOwnPropertySymbols?l=function(F){return Object.getOwnPropertyNames(F).concat(Object.getOwnPropertySymbols(F))}:l=function(F){return Object.getOwnPropertyNames(F)};function Z(F){console&&console.warn&&console.warn(F)}var L=Number.isNaN||function(F){return F!==F};function n(){n.init.call(this)}n.EventEmitter=n;n.prototype._events=void 0;n.prototype._eventsCount=0;n.prototype._maxListeners=void 0;var g=10;function p(F){if(typeof F!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof F)}Object.defineProperty(n,"defaultMaxListeners",{enumerable:!0,get:function(){return g},set:function(F){if(typeof F!="number"||F<0||L(F))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+F+".");g=F}});n.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};n.prototype.setMaxListeners=function(F){if(typeof F!="number"||F<0||L(F))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+F+".");return this._maxListeners=F,this};function a(F){return F._maxListeners===void 0?n.defaultMaxListeners:F._maxListeners}n.prototype.getMaxListeners=function(){return a(this)};n.prototype.emit=function(F){for(var E=[],C=1;C<arguments.length;C++)E.push(arguments[C]);var B=F==="error",A=this._events;if(A!==void 0)B=B&&A.error===void 0;else if(!B)return!1;if(B){var D;if(E.length>0&&(D=E[0]),D instanceof Error)throw D;var t=new Error("Unhandled error."+(D?" ("+D.message+")":""));throw t.context=D,t}var o=A[F];if(o===void 0)return!1;if(typeof o=="function")c(o,this,E);else for(var i=o.length,e=T(o,i),C=0;C<i;++C)c(e[C],this,E);return!0};function w(F,E,C,B){var A,D,t;if(p(C),D=F._events,D===void 0?(D=F._events=Object.create(null),F._eventsCount=0):(D.newListener!==void 0&&(F.emit("newListener",E,C.listener?C.listener:C),D=F._events),t=D[E]),t===void 0)t=D[E]=C,++F._eventsCount;else if(typeof t=="function"?t=D[E]=B?[C,t]:[t,C]:B?t.unshift(C):t.push(C),A=a(F),A>0&&t.length>A&&!t.warned){t.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+t.length+" "+String(E)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=F,o.type=E,o.count=t.length,Z(o)}return F}n.prototype.addListener=function(F,E){return w(this,F,E,!1)};n.prototype.on=n.prototype.addListener;n.prototype.prependListener=function(F,E){return w(this,F,E,!0)};function G(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function M(F,E,C){var B={fired:!1,wrapFn:void 0,target:F,type:E,listener:C},A=G.bind(B);return A.listener=C,B.wrapFn=A,A}n.prototype.once=function(F,E){return p(E),this.on(F,M(this,F,E)),this};n.prototype.prependOnceListener=function(F,E){return p(E),this.prependListener(F,M(this,F,E)),this};n.prototype.removeListener=function(F,E){var C,B,A,D,t;if(p(E),B=this._events,B===void 0)return this;if(C=B[F],C===void 0)return this;if(C===E||C.listener===E)--this._eventsCount===0?this._events=Object.create(null):(delete B[F],B.removeListener&&this.emit("removeListener",F,C.listener||E));else if(typeof C!="function"){for(A=-1,D=C.length-1;D>=0;D--)if(C[D]===E||C[D].listener===E){t=C[D].listener,A=D;break}if(A<0)return this;A===0?C.shift():K(C,A),C.length===1&&(B[F]=C[0]),B.removeListener!==void 0&&this.emit("removeListener",F,t||E)}return this};n.prototype.off=n.prototype.removeListener;n.prototype.removeAllListeners=function(F){var E,C,B;if(C=this._events,C===void 0)return this;if(C.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):C[F]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete C[F]),this;if(arguments.length===0){var A=Object.keys(C),D;for(B=0;B<A.length;++B)D=A[B],D!=="removeListener"&&this.removeAllListeners(D);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(E=C[F],typeof E=="function")this.removeListener(F,E);else if(E!==void 0)for(B=E.length-1;B>=0;B--)this.removeListener(F,E[B]);return this};function x(F,E,C){var B=F._events;if(B===void 0)return[];var A=B[E];return A===void 0?[]:typeof A=="function"?C?[A.listener||A]:[A]:C?V(A):T(A,A.length)}n.prototype.listeners=function(F){return x(this,F,!0)};n.prototype.rawListeners=function(F){return x(this,F,!1)};n.listenerCount=function(F,E){return typeof F.listenerCount=="function"?F.listenerCount(E):k.call(F,E)};n.prototype.listenerCount=k;function k(F){var E=this._events;if(E!==void 0){var C=E[F];if(typeof C=="function")return 1;if(C!==void 0)return C.length}return 0}n.prototype.eventNames=function(){return this._eventsCount>0?l(this._events):[]};function T(F,E){for(var C=new Array(E),B=0;B<E;++B)C[B]=F[B];return C}function K(F,E){for(;E+1<F.length;E++)F[E]=F[E+1];F.pop()}function V(F){for(var E=new Array(F.length),C=0;C<E.length;++C)E[C]=F[C].listener||F[C];return E}var t0=n.prototype;var u="0000ffe0-0000-1000-8000-00805f9b34fb",j="0000ffe2-0000-1000-8000-00805f9b34fb",P="0000ffe1-0000-1000-8000-00805f9b34fb",N=20,H=16,I=48;var q=80,d=85,U=86,R=100,S=81;var f=32;var m=[N,H],_={filters:[{services:[u]}]};class h extends n{constructor(){super();this.bleService=null,this.serialChar=null,this.atChar=null,this.respQueue=[],this._encoder=new TextEncoder,this._decoder=new TextDecoder,this._inFlash=!1,this.bleBusy=!1}requestPort(F=[]){return navigator.bluetooth.requestDevice(_).then((E)=>{return E.addEventListener("gattserverdisconnected",this.handleDisconnectError.bind(this)),E.gatt.connect()}).then((E)=>{this.bleServer=E,this.emit("open"),this.bleServer.getPrimaryService(u).then((C)=>C.getCharacteristic(P)).then((C)=>C.startNotifications()).then((C)=>{this.serialChar=C,C.addEventListener("characteristicvaluechanged",this.serialNotify.bind(this))}),this.bleServer.getPrimaryService(u).then((C)=>C.getCharacteristic(j)).then((C)=>C.startNotifications()).then((C)=>{this.atChar=C,C.addEventListener("characteristicvaluechanged",this.bleAtNotify.bind(this))})}).catch((E)=>{this.emit("error",E),console.log(E)})}init(F){this.bleServer=F,this.emit("open"),this.bleServer.getPrimaryService(u).then((E)=>E.getCharacteristic(P)).then((E)=>E.startNotifications()).then((E)=>{this.serialChar=E,E.addEventListener("characteristicvaluechanged",this.serialNotify.bind(this))}),this.bleServer.getPrimaryService(u).then((E)=>E.getCharacteristic(j)).then((E)=>E.startNotifications()).then((E)=>{this.atChar=E,E.addEventListener("characteristicvaluechanged",this.bleAtNotify.bind(this))})}disConnect(){this.emit("close")}getConnectStates(){return this.bleServer.connected}handleDisconnectError(F){console.log("disconnect "+F),this.emit("close")}serialNotify(F){if(!this._inFlash){let E=F.target.value,C=new Uint8Array(E.buffer);this.emit("data",C),console.log("serial_notify----"+E.byteLength+"  "+C)}}bleAtNotify(F){console.log("bleAt_notify----"+this._decoder.decode(F.target.value))}waitForResponse(F,E,C=5000){return new Promise((B,A)=>{let D,t=(o)=>{let i=o.target.value;for(let e=0;e<i.byteLength;e++){let s=i.getUint8(e);this.respQueue.push(s)}if(this.bufferEqual(E,new Uint8Array(this.respQueue)))console.log("rr "+this.respQueue),clearTimeout(D),F.removeEventListener("characteristicvaluechanged",t),B(this.respQueue)};D=setTimeout(()=>{F.removeEventListener("characteristicvaluechanged",t),A(new Error("Timeout waiting for the expected response."))},C),console.log("监听啦"),this.respQueue=[],F.addEventListener("characteristicvaluechanged",t)})}async sendATMessage(F){console.log("发送了 "+F),F=F+`\r
`;let E=this._encoder.encode(F);await this.atChar.writeValueWithResponse(E)}async sendSerialMessage(F){await this.serialChar.writeValueWithResponse(F)}async sendSerialMessageWithResp(F){if(this.bleBusy){console.log("1"),setTimeout(()=>this.sendSerialMessageWithResp(F),10),console.log("2");return}try{this.bleBusy=!0,console.log("3"),await this.sendSerialMessage(F)}finally{this.bleBusy=!1}}async sendSerialAndTestRet(F,E){await this.sendSerialMessage(F);let C=await this.waitForResponse(this.serialChar,E);return this.bufferEqual(E,new Uint8Array(C))}async flash(F){this._inFlash=!0;let E=this.parseIntelHex(F);console.log("开始烧录啦");try{await this.sendATMessage("AT+TARGE_RESET"),await new Promise((O)=>setTimeout(O,100));let C=new Uint8Array([I,f]),B=new Uint8Array(m);if(!await this.sendSerialAndTestRet(C,B))throw new Error("stk500 sync error");let D=new Uint8Array([q,f]);if(!await this.sendSerialAndTestRet(D,B))throw new Error("stk500 enter progmodel error");let o=new Uint8Array([U,172,128,0,0,f]),i=new Uint8Array([N,0,H]);if(!await this.sendSerialAndTestRet(o,i))throw new Error("stk500 universal error");await this.upload(E);let s=new Uint8Array([S,f]);if(!await this.sendSerialAndTestRet(s,B))throw new Error("stk500 leaveProgMode error");else console.log("leaveProgMode")}catch(C){console.log(C)}finally{this._inFlash=!1}console.log("烧录成功啦")}async upload(F){let C=0,B=null,A=null;try{while(C<F.length)console.log("program page"),A=C>>1,await this.loadAddress(A),B=F.slice(C,F.length>128?C+128:F.length-1),await this.loadPage(B),console.log("programmed page"),C=C+B.length,await new Promise((D)=>setTimeout(D,4)),console.log("page done")}catch(D){throw D}return console.log("upload done"),!0}async loadAddress(F){let E=F&255,C=F>>8&255,B=new Uint8Array([d,E,C,f]),A=new Uint8Array(m);if(console.log("loadAddress"),!await this.sendSerialAndTestRet(B,A))throw new Error("stk500 loadAddress error")}async loadPage(F){let E=F.length&255,C=F.length>>8,B=new Uint8Array([R,C,E,70]);await this.sendSerialMessage(B);let A=0;console.log("loadAddress");let D=F.length;while(A<D){let e=Math.min(30,D-A);console.log("splitLength:",e);let s=F.slice(A,A+e);await this.sendSerialMessage(new Uint8Array(s)),A+=e}let t=new Uint8Array([f]),o=new Uint8Array(m);if(!await this.sendSerialAndTestRet(t,o))throw new Error("stk500 loadPage error")}mergeUint8Arrays(...F){let E=F.reduce((A,D)=>A+D.length,0),C=new Uint8Array(E),B=0;for(let A of F)C.set(A,B),B+=A.length;return C}parseIntelHex(F){let E=[],C=typeof F==="string"?F:new TextDecoder("utf-8").decode(F);var B=0;for(let D of C.split(/\s*\n\s*/)){if(D.length<1)continue;if(D[0]!=":")throw new Error("Hex file has a line not starting with ':'");let t=parseInt(D.substring(1,3),16),o=parseInt(D.substring(3,7),16)+B,i=parseInt(D.substring(7,9),16);if(D.length!=t*2+11)throw new Error("Error in hex file: "+D);var A=0;for(let e=0;e<t+5;e++)A+=parseInt(D.substring(e*2+1,e*2+3),16);if(A&=255,A!=0)throw new Error("Checksum error in hex file: "+D);switch(i){case 0:while(E.length<o+t)E.push(0);for(let e=0;e<t;e++)E[o+e]=parseInt(D.substring(e*2+9,e*2+11),16);break;case 1:break;case 2:B=parseInt(D.substring(9,13),16)*16;break;default:console.log(i,t,o,A,D)}}return E}bufferEqual(F,E){if(F.length!==E.length)return!1;for(let C=0;C<F.length;C++)if(F[C]!==E[C])return!1;return!0}}var X="./assets/FirmataTest-3ksse6n1.hex";class v extends n{constructor(F){super();this._ble=F,this._ble.on("close",(E)=>{this.emit("close",E)}),this._ble.on("open",(E)=>{this.emit("open",E)}),this._ble.on("error",(E)=>{this.emit("error",E)}),this._ble.on("data",(E)=>{console.log(E),this.emit("data",E)})}connect(){this._ble.requestPort()}disConnect(){this._ble.disConnect()}async write(F,E){console.log(F),console.log(E),await this._ble.sendSerialMessageWithResp(F),E()}async flash(F){await this._ble.flash(F)}async flashHex(){let E=await(await fetch(X)).arrayBuffer();await this.flash(E)}}import{Firmata as W}from"@blockcode/utils";class Q{constructor(){this.arduinoBle=new h,this.bleSerialPort=new v(this.arduinoBle),this.board=null}get key(){return"firmata"}connect(F){this.arduinoBle.init(F),this.board=new W(this.bleSerialPort)}disConnect(){this.arduinoBle.disConnect()}flash(){this.arduinoBle.requestPort().then(async()=>{await new Promise((F)=>setTimeout(F,2000)),this.bleSerialPort.flashHex()})}testConnect(){this.arduinoBle.requestPort().then(async()=>{await new Promise((F)=>setTimeout(F,2000)),this.board=new W(this.bleSerialPort,{skipCapabilities:!0}),this.board.on("ready",()=>{console.log("  ✔ ready")}),this.board.on("reportVersionTimeout",()=>{console.log("reportVersionTimeout")}),this.board.once("analog-mapping-query",()=>{console.log("analog-mapping-query")})})}}function Y(F,E){let C=new Q;return F.on("connecting",(B)=>{console.log("onnconetec"),C.connect(B)}),F.on("disconnect",()=>{C.disConnect()}),C}import{Text as b}from"@blockcode/core";import{jsx as y}from"preact/jsx-runtime";var $=[{id:"blockA",text:y(b,{id:"blocks.firmata.blockA",defaultMessage:"block [KEY]"}),inputs:{KEY:{type:"string",defaultValue:"a"}},emu(F){let E="";if(this.STATEMENT_PREFIX)E+=this.injectId(this.STATEMENT_PREFIX,F);let C=this.valueToCode(F,"KEY",this.ORDER_NONE)||'""';return E+=`console.log(${C});
`,E}},{id:"connect",text:y(b,{id:"blocks.firmata.connect",defaultMessage:"connect"}),emu(F){let E="";if(this.STATEMENT_PREFIX)E+=this.injectId(this.STATEMENT_PREFIX,F);return E+=`runtime.extensions.firmata.testConnect();
`,E}},{id:"flash",text:y(b,{id:"blocks.firmata.flash",defaultMessage:"flash"}),emu(F){let E="";if(this.STATEMENT_PREFIX)E+=this.injectId(this.STATEMENT_PREFIX,F);return E+=`runtime.extensions.firmata.flash();
`,E}}];var z={en:{"blocks.firmata.name":"Arduino Firmata","blocks.firmata.blockA":"block [KEY]","blocks.firmata.connect":"block"},"zh-Hans":{"blocks.firmata.name":"Arduino Firmata","blocks.firmata.blockA":"积木 [KEY]","blocks.firmata.connect":"连接"},"zh-Hant":{"blocks.firmata.name":"Arduino Firmata","blocks.firmata.blockA":"積木 [KEY]","blocks.firmata.connect":"连接"}};var J="./assets/icon-7mgxv3je.png";import{jsx as D0}from"preact/jsx-runtime";C0(z);var x0={icon:J,name:D0(B0,{id:"blocks.firmata.name",defaultMessage:"Arduino Firmata"}),statusButton:{connectionOptions:{bluetooth:{filters:[{services:["0000ffe0-0000-1000-8000-00805f9b34fb"]}]}}},emulator:Y,blocks:$};export{x0 as default};
