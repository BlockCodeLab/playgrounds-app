import{addLocalesMessages as R,Text as I}from"@blockcode/core";import{batch as g}from"@preact/signals";import{setMeta as q,addAsset as c,delAsset as P,openPromptModal as S,Text as E,translate as M}from"@blockcode/core";var l="./assets/quan-bz1kz289.ttf";var o="quan",x=8,$=new FontFace(o,`url(${l})`);document.fonts.add($);$.load();var s=(p)=>{let X=document.createElement("canvas").getContext("2d",{willReadFrequently:!0});X.font=`${x}px ${o}`,X.textAlign="left",X.textBaseline="top",X.fillStyle="#ffffff",X.fillRect(0,0,10,10),X.fillStyle="#000000",X.fillText(p,0,0);let{data:i}=X.getImageData(0,0,x,x),n=[],C=[];for(let D=0;D<i.length;D+=4)if(C.push(i[D]===0&&i[D+1]===0&&i[D+2]===0?1:0),C.length===x)n.push(C),C=[];let u=[];for(let D=0;D<x;D++){C=[];for(let A=0;A<x;A++)C.push(n[A][D]);u.push(`00${parseInt(C.join(""),2).toString(16)}`.slice(-2))}let B=u.length;for(let D=0;D<B;D++){if(u[0]!=="00")break;u.shift()}B=u.length;for(let D=0;D<B;D++){if(u.at(-1)!=="00")break;u.pop()}if(u.length===0)return;return u},f=(p)=>{let d=new Map,X=[],i=0,n="";p=p.trim();for(let B of p){if(B===" ")continue;let D=s(B);if(D){if(D.length>i)i=D.length;d.set(B,D)}}let C=`00${Math.ceil(i/2).toString(16)}`.slice(-2);n+=`  {${"0x00,".repeat(i)}0x${C}}, // 空格
`,X.push(" "),Array.from(d.entries()).forEach(([B,D])=>{let A="0x00,".repeat(i-D.length),t=`00${D.length.toString(16)}`.slice(-2),Z=`// ${B==="\\"?"backslash":B}`;n+=`  {0x${D.join(",0x")},${A}0x${t}}, ${Z}
`,X.push(B)});let u="";return u+=`static byte FONTS[${d.size+1}][${i+1}] = {
${n}};
`,u+=`static char *FONT_MAP[] = {"${X.map((B)=>B==='"'?"\\\"":B==="\\"?"\\\\":B).join('","')}"};
`,u+=`static int FONT_COUNT = ${d.size+1};
`,u+=`static int FONT_WIDTH_INDEX = ${i};
`,{content:u,map:X}},e=(p)=>{let d=new Map,X=[],i=0,n="";p=p.trim();for(let B of p){if(B===" ")continue;let D=s(B);if(D){if(D.length>i)i=D.length;d.set(B,D)}}let C=`00${Math.ceil(i/2).toString(16)}`.slice(-2);n+=`  b"${"\\x00".repeat(i)}\\x${C}", # 空格
`,X.push(" "),Array.from(d.entries()).forEach(([B,D])=>{let A="\\x00".repeat(i-D.length),t=`00${D.length.toString(16)}`.slice(-2);n+=`  b"\\x${D.join("\\x")}${A}\\x${t}", # ${B}
`,X.push(B)});let u=`USER_FONTS = (
${n})
`;return u+=`USER_FONT_WIDTH_INDEX = ${i}
`,u+=`USER_FONT_MAP = "${X.join("").replace('"',"\\\"")}"
`,{content:u,map:X}};function a(p){let d=globalThis.document,X=d.createElement("style");X.appendChild(d.createTextNode(p)),d.head.append(X)}a(".rbBgHG_text-input{border:1px solid var(--ui-black-transparent);width:30rem;color:var(--text-primary);resize:none;border-radius:5px;padding:.5rem;font-size:.875rem}");var h={textInput:"rbBgHG_text-input"};import{jsx as F}from"preact/jsx-runtime";var r=(p)=>p.editor==="@blockcode/gui-iotbit",T=(p)=>[{button:"FONT_CREATOR",text:F(E,{id:"blocks.matrix7219.fontCreator",defaultMessage:"Font Creator"}),onClick(){return new Promise((d)=>{S({title:F(E,{id:"blocks.matrix7219.fontCreator",defaultMessage:"Font Creator"}),label:F(E,{id:"blocks.matrix7219.fontCreatorLabel",defaultMessage:"Enter the non-English characters to add to the fonts: (max {count})",count:127}),body:F("textarea",{id:"matrix7219_font_creator",rows:"5",maxLength:"127",className:h.textInput,placeholder:M("blocks.matrix7219.fontCreatorPlaceholder","Enter characters..."),children:p.users?.fonts?.trim()??""}),onSubmit(){let X=p.editor==="@blockcode/gui-arduino",i=document.getElementById("matrix7219_font_creator").value,n=i?X?`#pragma once
#include <Arduino.h>
${f(i)}`:e(i):{map:[],content:""};g(()=>{if(q({users:{...p.users??{},fonts:n.map.join("")}}),X)i?c({id:"user_fonts.h",name:"user_fonts",type:"text/x-c",content:n.content}):P("user_fonts.h");else i?c({id:"/lib/user_fonts/matrix7219",name:"user_fonts",type:"text/x-python",content:n.content}):P("/lib/user_fonts/matrix7219");d(!0)})}})})}},{id:"init",text:F(E,{id:"blocks.matrix7219.init",defaultMessage:"set pins CLK:[CLK] DIN:[DIN] CS:[CS]"}),inputs:{CLK:p.boardPins?{menu:p.boardPins.out,defaultValue:r(p)?"33":"2"}:{type:"positive_integer",defaultValue:2},DIN:p.boardPins?{menu:p.boardPins.out,defaultValue:r(p)?"35":"3"}:{type:"positive_integer",defaultValue:3},CS:p.boardPins?{menu:p.boardPins.out,defaultValue:r(p)?"32":"4"}:{type:"positive_integer",defaultValue:4}},ino(d){let X=p.boardPins?d.getFieldValue("CLK"):this.valueToCode(d,"CLK",this.ORDER_NONE),i=p.boardPins?d.getFieldValue("DIN"):this.valueToCode(d,"DIN",this.ORDER_NONE),n=p.boardPins?d.getFieldValue("CS"):this.valueToCode(d,"CS",this.ORDER_NONE),C=this.definitions_.variable_matrix7219_devices?.replace("// MAX7219 devices: ","")||1;return delete this.definitions_.variable_matrix7219_devices,this.definitions_.variable_matrix7219=`Matrix7219 _matrix7219(${X}, ${i}, ${n}, ${C});`,""},mpy(d){let X=p.boardPins?d.getFieldValue("CLK"):this.valueToCode(d,"CLK",this.ORDER_NONE),i=p.boardPins?d.getFieldValue("DIN"):this.valueToCode(d,"DIN",this.ORDER_NONE),n=p.boardPins?d.getFieldValue("CS"):this.valueToCode(d,"CS",this.ORDER_NONE),C=this.definitions_.matrix7219_devices?.replace("# MAX7219 devices: ","")||1;return delete this.definitions_.matrix7219_devices,this.definitions_.matrix7219=`_matrix7219 = matrix7219.Matrix7219(${X}, ${i}, ${n}, ${C})`,""}},{id:"devices",text:F(E,{id:"blocks.matrix7219.devices",defaultMessage:"set matrix devices [NUM]"}),inputs:{NUM:{type:"positive_integer",defaultValue:"1"}},ino(d){let X=this.valueToCode(d,"NUM",this.ORDER_NONE);if(this.definitions_.variable_matrix7219)this.definitions_.variable_matrix7219=this.definitions_.variable_matrix7219.replace(/\d+\);$/,`${X});`);else this.definitions_.variable_matrix7219_devices=`// MAX7219 devices: ${X}`;return""},mpy(d){let X=this.valueToCode(d,"NUM",this.ORDER_NONE);if(this.definitions_.matrix7219)this.definitions_.matrix7219=this.definitions_.matrix7219.replace(/\d+\)$/,`${X})`);else this.definitions_.matrix7219_devices=`# MAX7219 devices: ${X}`;return""}},"---",{id:"display",text:F(E,{id:"blocks.matrix7219.display",defaultMessage:"display [MATRIX] on device [IDX]"}),inputs:{MATRIX:{shadow:"matrix88",defaultValue:"0000000001100110111111111111111111111111011111100011110000011000"},IDX:{type:"positive_integer",defaultValue:1}},ino(d){let X=this.getAdjusted(d,"IDX"),i=this.valueToCode(d,"MATRIX",this.ORDER_NONE);return`_matrix7219.showMatrix(${X}, (byte[]){${i}});
`},mpy(d){let X=this.getAdjusted(d,"IDX"),i=this.valueToCode(d,"MATRIX",this.ORDER_NONE),n="";return n+=`_matrix7219.show_matrix(${X}, b"${i}")
`,n}},{id:"matrix88",shadow:!0,output:"string",inputs:{MATRIX:{type:"matrix",width:8,height:8}},ino(d){let X=d.getFieldValue("MATRIX"),i=[];for(let n=0;n<8;n++){let C=X.slice(n*8,(n+1)*8),u=`00${parseInt(C,2).toString(16)}`.slice(-2);i.push(u)}return[`0x${i.join(",0x")}`,this.ORDER_ATOMIC]},mpy(d){let X=d.getFieldValue("MATRIX"),i=[];for(let n=0;n<8;n++){let C=X.slice(n*8,(n+1)*8),u=`00${parseInt(C,2).toString(16)}`.slice(-2);i.push(u)}return[`\\x${i.join("\\x")}`,this.ORDER_ATOMIC]}},{id:"text",text:F(E,{id:"blocks.matrix7219.text",defaultMessage:"display [MSG]"}),inputs:{MSG:{type:"string",defaultValue:"abc"}},ino(d){let i=this.valueToCode(d,"MSG",this.ORDER_NONE).replace(/^['"]/,"").replace(/['"]$/,""),n=i.split("").map((u)=>`"${u==='"'?"\\\"":u==="\\"?"\\\\":u}"`);if(/[^\x20-\x7E]/.test(i)){if(delete this.definitions_.include_user_fonts,p.users?.fonts)return this.definitions_.include_user_fonts='#include "user_fonts.h"',`SHOW_TEXT(_matrix7219, ${n});
`;let u="";if(this.definitions_.variable_user_fonts)u=this.definitions_.variable_user_fonts,u=u.slice(u.indexOf('static char *USER_FONT_MAP[] = {"')+33,u.lastIndexOf('"};')),u=u.replaceAll('","',"");let B=f(u+i);return this.definitions_.variable_user_fonts=B.content,`SHOW_TEXT(_matrix7219, ${n});
`}return this.definitions_.include_user_fonts='#include "fonts8x8.h"',`SHOW_TEXT(_matrix7219, ${n});
`},mpy(d){let X=this.valueToCode(d,"MSG",this.ORDER_NONE),i=X.replace(/^['"]/,"").replace(/['"]$/,"");if(/[^\x20-\x7E]/.test(i)){if(p.users?.fonts)return this.definitions_.import_user_fonts="from user_fonts.matrix7219 import *",`_matrix7219.show_text(${X}, USER_FONTS, USER_FONT_MAP, USER_FONT_WIDTH_INDEX)
`;let C="";if(this.definitions_.user_fonts)C=this.definitions_.user_fonts,C=C.slice(C.indexOf('USER_FONT_MAP = "')+17,C.lastIndexOf('"'));let u=e(C+i);return this.definitions_.user_fonts=u.content,`_matrix7219.show_text(${X}, USER_FONTS, USER_FONT_MAP, USER_FONT_WIDTH_INDEX)
`}return`_matrix7219.show_text(${X})
`}},{id:"clear",text:F(E,{id:"blocks.matrix7219.clear",defaultMessage:"clear device [IDX]"}),inputs:{IDX:{type:"positive_integer",defaultValue:"1"}},ino(d){return`_matrix7219.clearDisplay(${this.getAdjusted(d,"IDX")});
`},mpy(d){return`_matrix7219.clear_display(${this.getAdjusted(d,"IDX")})
`}},{id:"clearall",text:F(E,{id:"blocks.matrix7219.clearall",defaultMessage:"clear all devices"}),ino(d){let X="";return X+=`for (int i=0; i< _matrix7219.getDeviceCount(); i++)
`,X+=`  _matrix7219.clearDisplay(i);
`,X},mpy(d){return`_matrix7219.clear_display()
`}},"---",{id:"brightness",text:F(E,{id:"blocks.matrix7219.brightness",defaultMessage:"set device [IDX] brightness [LEVEL]"}),inputs:{IDX:{type:"positive_integer",defaultValue:1},LEVEL:{shadow:"brightnessLevel",defaultValue:"8"}},ino(d){let X=this.getAdjusted(d,"IDX"),i=this.valueToCode(d,"LEVEL",this.ORDER_NONE);return`_matrix7219.setIntensity(${X}, ${i});
`},mpy(d){let X=this.getAdjusted(d,"IDX"),i=this.valueToCode(d,"LEVEL",this.ORDER_NONE);return`_matrix7219.set_intensity(${X}, ${i})
`}},{id:"brightnessall",text:F(E,{id:"blocks.matrix7219.brightnessall",defaultMessage:"set all devices brightness [LEVEL]"}),inputs:{LEVEL:{shadow:"brightnessLevel",defaultValue:"8"}},ino(d){let X=this.valueToCode(d,"LEVEL",this.ORDER_NONE),i="";return i+=`for (int i=0; i< _matrix7219.getDeviceCount(); i++)
`,i+=`  _matrix7219.setIntensity(i, ${X});
`,i},mpy(d){let X=this.valueToCode(d,"LEVEL",this.ORDER_NONE),i="";return i+=`for i in range(_matrix7219.get_device_count()):
`,i+=`  _matrix7219.set_intensity(i, ${X})
`,i}},{id:"brightnessLevel",shadow:!0,output:"number",inputs:{LEVEL:{type:"slider",defaultValue:0,min:0,max:15}},mpy(d){return[d.getFieldValue("LEVEL")||0,this.ORDER_NONE]},ino(d){return[d.getFieldValue("LEVEL")||0,this.ORDER_NONE]}}],L={iotOutPins:{items:[["P0","33"],["P1","32"],["P5","0"],["P6","16"],["P7","17"],["P8","26"],["P9","25"],["P11","2"],["P13","18"],["P14","19"],["P15","21"],["P16","5"],["P19","22"],["P20","23"],["P23","27"],["P24","14"],["P25","12"],["P26","13"],["P27","15"],["P28","4"]]}};var w="./assets/fonts8x8-s5dfpbc6.h";var _="./assets/matrix7219-5bj935dp.h";var b="./assets/matrix7219-c70n0524.cpp";var m="./assets/matrix7219-1sq7nvp8.py";var H=(p)=>{if(p.editor==="@blockcode/gui-arduino")return[{header:!0,name:"matrix7219.h",type:"text/x-c",uri:_},{name:"matrix7219.cpp",type:"text/x-c",uri:b},{name:"fonts8x8.h",type:"text/x-c",uri:w}];return[{name:"matrix7219",type:"text/x-python",uri:m}]};var v={en:{"blocks.matrix7219.name":"MAX7219 Matrix","blocks.matrix7219.fontCreator":"Font Creator","blocks.matrix7219.fontCreatorLabel":"Enter the non-English characters(max {count}) to add to the font:","blocks.matrix7219.fontCreatorPlaceholder":"Enter characters...","blocks.matrix7219.init":"set pins CLK:[CLK] DIN:[DIN] CS:[CS]","blocks.matrix7219.devices":"set matrix devices [NUM]","blocks.matrix7219.display":"display [MATRIX] on device [IDX]","blocks.matrix7219.text":"display [MSG]","blocks.matrix7219.rotate":"rotate device [IDX] to [ANGLE]","blocks.matrix7219.brightness":"set device [IDX] brightness [LEVEL]","blocks.matrix7219.brightnessall":"set all devices brightness [LEVEL]","blocks.matrix7219.clear":"clear device [IDX]","blocks.matrix7219.clearall":"clear all devices"},"zh-Hans":{"blocks.matrix7219.name":"MAX7219 灯点阵","blocks.matrix7219.fontCreator":"自定义字库","blocks.matrix7219.fontCreatorLabel":"请输入字库包含的非英文字符（最多 {count} 个）：","blocks.matrix7219.fontCreatorPlaceholder":"输入字符…","blocks.matrix7219.init":"初始引脚 CLK:[CLK] DIN:[DIN] CS:[CS]","blocks.matrix7219.devices":"初始屏数 [NUM]","blocks.matrix7219.display":"在第[IDX]屏显示[MATRIX]","blocks.matrix7219.text":"显示[MSG]","blocks.matrix7219.rotate":"将第[IDX]屏旋转[ANGLE]","blocks.matrix7219.brightness":"将第[IDX]屏亮度设为[LEVEL]","blocks.matrix7219.brightnessall":"将所有屏亮度设为[LEVEL]","blocks.matrix7219.clear":"清除第[IDX]屏","blocks.matrix7219.clearall":"清除所有屏"},"zh-Hant":{"blocks.matrix7219.name":"MAX7219 燈點陣","blocks.matrix7219.fontCreator":"生成字庫","blocks.matrix7219.fontCreatorLabel":"請輸入字庫包含的非英文字符（最多 {count} 個）：","blocks.matrix7219.fontCreatorPlaceholder":"輸入字符…","blocks.matrix7219.init":"初始引腳 CLK:[CLK] DIN:[DIN] CS:[CS]","blocks.matrix7219.devices":"初始屏數 [NUM]","blocks.matrix7219.display":"在第[IDX]屏顯示[MATRIX]","blocks.matrix7219.text":"顯示[MSG]","blocks.matrix7219.rotate":"將第[IDX]屏旋轉[ANGLE]","blocks.matrix7219.brightness":"將第[IDX]屏亮度設為[LEVEL]","blocks.matrix7219.brightnessall":"將所有屏亮度設為[LEVEL]","blocks.matrix7219.clear":"清除第[IDX]屏","blocks.matrix7219.clearall":"清除所有屏"}};var y="./assets/icon-ywrnbn6c.svg";var k="./assets/icon-block-gadbsa57.svg";import{jsx as N}from"preact/jsx-runtime";R(v);var Ld={icon:y,blockIcon:k,name:N(I,{id:"blocks.matrix7219.name",defaultMessage:"LED Matrix"}),files:H,blocks:T,menus:L};export{Ld as default};
