import{addLocalesMessages as N,Text as G}from"@blockcode/core";import{batch as S}from"@preact/signals";import{setMeta as M,addAsset as P,delAsset as T,openPromptModal as Y,Text as E,translate as U}from"@blockcode/core";var $="./assets/quan-bz1kz289.ttf";var s="quan",x=8,a=new FontFace(s,`url(${$})`);document.fonts.add(a);a.load();var q=document.createElement("canvas"),A=q.getContext("2d",{willReadFrequently:!0});a.loaded.then(()=>{A.font=`${x}px ${s}`,A.textAlign="left",A.textBaseline="top"}).catch((p)=>{console.log(p)});var h=(p)=>{A.fillStyle="#ffffff",A.fillRect(0,0,10,10),A.fillStyle="#000000",A.fillText(p,0,0);let{data:d}=A.getImageData(0,0,x,x),i=[],X=[];for(let u=0;u<d.length;u+=4)if(X.push(d[u]===0&&d[u+1]===0&&d[u+2]===0?1:0),X.length===x)i.push(X),X=[];let n=[];for(let u=0;u<x;u++){X=[];for(let D=0;D<x;D++)X.push(i[D][u]);n.push(`00${parseInt(X.join(""),2).toString(16)}`.slice(-2))}let C=n.length;for(let u=0;u<C;u++){if(n[0]!=="00")break;n.shift()}C=n.length;for(let u=0;u<C;u++){if(n.at(-1)!=="00")break;n.pop()}if(n.length===0)return;return n},r=(p)=>{let d=new Map,i=[],X=0,n="";p=p.trim();for(let D of p){if(D===" ")continue;let B=h(D);if(B){if(B.length>X)X=B.length;d.set(D,B)}}let C=`00${Math.ceil(X/2).toString(16)}`.slice(-2);n+=`  {${"0x00,".repeat(X)}0x${C}}, // 空格
`,i.push(" "),Array.from(d.entries()).forEach(([D,B])=>{let f="0x00,".repeat(X-B.length),e=`00${B.length.toString(16)}`.slice(-2),z=`// ${D==="\\"?"backslash":D}`;n+=`  {0x${B.join(",0x")},${f}0x${e}}, ${z}
`,i.push(D)});let u=`#pragma once
`;return u+=`#include <Arduino.h>
`,u+=`static byte FONTS[${d.size+1}][${X+1}] = {
${n}};
`,u+=`static char *FONT_MAP[] = {"${i.map((D)=>D==='"'?"\\\"":D==="\\"?"\\\\":D).join('","')}"};
`,u+=`static int FONT_COUNT = ${d.size+1};
`,u+=`static int FONT_WIDTH_INDEX = ${X};
`,{content:u,map:i}},l=(p)=>{let d=new Map,i=[],X=0,n="";p=p.trim();for(let D of p){if(D===" ")continue;let B=h(D);if(B){if(B.length>X)X=B.length;d.set(D,B)}}let C=`00${Math.ceil(X/2).toString(16)}`.slice(-2);n+=`  b"${"\\x00".repeat(X)}\\x${C}", # 空格
`,i.push(" "),Array.from(d.entries()).forEach(([D,B])=>{let f="\\x00".repeat(X-B.length),e=`00${B.length.toString(16)}`.slice(-2);n+=`  b"\\x${B.join("\\x")}${f}\\x${e}", # ${D}
`,i.push(D)});let u=`USER_FONTS = (
${n})
`;return u+=`USER_FONT_WIDTH_INDEX = ${X}
`,u+=`USER_FONT_MAP = "${i.join("").replace('"',"\\\"")}"
`,{content:u,map:i}};function o(p){let d=globalThis.document,i=d.createElement("style");i.appendChild(d.createTextNode(p)),d.head.append(i)}o(".rbBgHG_text-input{border:1px solid var(--ui-black-transparent);width:30rem;color:var(--text-primary);resize:none;border-radius:5px;padding:.5rem;font-size:.875rem}");var c={textInput:"rbBgHG_text-input"};import{jsx as F}from"preact/jsx-runtime";var t=(p)=>p.editor==="@blockcode/gui-iotbit",L=(p)=>[{button:"FONT_CREATOR",text:F(E,{id:"blocks.matrix7219.fontCreator",defaultMessage:"Font Creator"}),onClick(){return new Promise((d)=>{Y({title:F(E,{id:"blocks.matrix7219.fontCreator",defaultMessage:"Font Creator"}),label:F(E,{id:"blocks.matrix7219.fontCreatorLabel",defaultMessage:"Enter the non-English characters to add to the fonts: (max {count})",count:127}),body:F("textarea",{id:"matrix7219_font_creator",rows:"5",maxLength:"127",className:c.textInput,placeholder:U("blocks.matrix7219.fontCreatorPlaceholder","Enter characters..."),children:p.users?.fonts?.trim()??""}),onSubmit(){let i=p.editor==="@blockcode/gui-arduino",X=document.getElementById("matrix7219_font_creator").value,n=X?i?r(X):l(X):{map:[],content:""};S(()=>{if(M({users:{...p.users??{},fonts:n.map.join("")}}),i)X?P({id:"user_fonts.h",name:"user_fonts",type:"text/x-c",content:n.content}):T("user_fonts.h");else X?P({id:"/lib/user_fonts/matrix7219",name:"user_fonts",type:"text/x-python",content:n.content}):T("/lib/user_fonts/matrix7219");d(!0)})}})})}},{id:"init",text:F(E,{id:"blocks.matrix7219.init",defaultMessage:"set pins CLK[CLK] DIN[DIN] CS[CS]"}),inputs:{CLK:t(p)?{menu:"iotOutPins",defaultValue:"P5"}:{type:"positive_integer",defaultValue:2},DIN:t(p)?{menu:"iotOutPins",defaultValue:"P6"}:{type:"positive_integer",defaultValue:3},CS:t(p)?{menu:"iotOutPins",defaultValue:"P7"}:{type:"positive_integer",defaultValue:4}},ino(d){let i=this.valueToCode(d,"CLK",this.ORDER_NONE),X=this.valueToCode(d,"DIN",this.ORDER_NONE),n=this.valueToCode(d,"CS",this.ORDER_NONE),C=this.definitions_.variable_matrix7219_devices?.replace("// MAX7219 devices: ","")||1;return delete this.definitions_.variable_matrix7219_devices,this.definitions_.variable_matrix7219=`Matrix7219 _matrix7219(${i}, ${X}, ${n}, ${C});`,""},mpy(d){let i=t(p)?d.getFieldValue("CLK"):this.valueToCode(d,"CLK",this.ORDER_NONE),X=t(p)?d.getFieldValue("DIN"):this.valueToCode(d,"DIN",this.ORDER_NONE),n=t(p)?d.getFieldValue("CS"):this.valueToCode(d,"CS",this.ORDER_NONE),C=this.definitions_.matrix7219_devices?.replace("# MAX7219 devices: ","")||1;return delete this.definitions_.matrix7219_devices,this.definitions_.matrix7219=`_matrix7219 = matrix7219.Matrix7219(${i}, ${X}, ${n}, ${C})`,""}},{id:"devices",text:F(E,{id:"blocks.matrix7219.devices",defaultMessage:"set matrix devices [NUM]"}),inputs:{NUM:{type:"positive_integer",defaultValue:"1"}},ino(d){let i=this.valueToCode(d,"NUM",this.ORDER_NONE);if(this.definitions_.variable_matrix7219)this.definitions_.variable_matrix7219=this.definitions_.variable_matrix7219.replace(/\d+\);$/,`${i});`);else this.definitions_.variable_matrix7219_devices=`// MAX7219 devices: ${i}`;return""},mpy(d){let i=this.valueToCode(d,"NUM",this.ORDER_NONE);if(this.definitions_.matrix7219)this.definitions_.matrix7219=this.definitions_.matrix7219.replace(/\d+\)$/,`${i})`);else this.definitions_.matrix7219_devices=`# MAX7219 devices: ${i}`;return""}},"---",{id:"display",text:F(E,{id:"blocks.matrix7219.display",defaultMessage:"display [MATRIX] on device [IDX]"}),inputs:{MATRIX:{shadow:"matrix88",defaultValue:"0000000001100110111111111111111111111111011111100011110000011000"},IDX:{type:"positive_integer",defaultValue:1}},ino(d){let i=this.getAdjusted(d,"IDX"),X=this.valueToCode(d,"MATRIX",this.ORDER_NONE);return`_matrix7219.showMatrix(${i}, (byte[]){${X}});
`},mpy(d){let i=this.getAdjusted(d,"IDX"),X=this.valueToCode(d,"MATRIX",this.ORDER_NONE),n="";return n+=`_matrix7219.show_matrix(${i}, b"${X}")
`,n}},{id:"matrix88",shadow:!0,output:"string",inputs:{MATRIX:{type:"matrix",width:8,height:8}},ino(d){let i=d.getFieldValue("MATRIX"),X=[];for(let n=0;n<8;n++){let C=i.slice(n*8,(n+1)*8),u=`00${parseInt(C,2).toString(16)}`.slice(-2);X.push(u)}return[`0x${X.join(",0x")}`,this.ORDER_ATOMIC]},mpy(d){let i=d.getFieldValue("MATRIX"),X=[];for(let n=0;n<8;n++){let C=i.slice(n*8,(n+1)*8),u=`00${parseInt(C,2).toString(16)}`.slice(-2);X.push(u)}return[`\\x${X.join("\\x")}`,this.ORDER_ATOMIC]}},{id:"text",text:F(E,{id:"blocks.matrix7219.text",defaultMessage:"display [MSG]"}),inputs:{MSG:{type:"string",defaultValue:"abc"}},ino(d){let X=this.valueToCode(d,"MSG",this.ORDER_NONE).replace(/^['"]/,"").replace(/['"]$/,""),n=X.split("").map((u)=>`"${u==='"'?"\\\"":u==="\\"?"\\\\":u}"`);if(/[^\x20-\x7E]/.test(X)){if(delete this.definitions_.include_user_fonts,p.users?.fonts)return this.definitions_.include_user_fonts='#include "user_fonts.h"',`SHOW_TEXT(_matrix7219, ${n});
`;let u="";if(this.definitions_.variable_user_fonts)u=this.definitions_.variable_user_fonts,u=u.slice(u.indexOf('static char *USER_FONT_MAP[] = {"')+33,u.lastIndexOf('"};')),u=u.replaceAll('","',"");let D=r(u+X);return this.definitions_.variable_user_fonts=D.content,`SHOW_TEXT(_matrix7219, ${n});
`}return this.definitions_.include_user_fonts='#include "fonts8x8.h"',`SHOW_TEXT(_matrix7219, ${n});
`},mpy(d){let i=this.valueToCode(d,"MSG",this.ORDER_NONE),X=i.replace(/^['"]/,"").replace(/['"]$/,"");if(/[^\x20-\x7E]/.test(X)){if(p.users?.fonts)return this.definitions_.import_user_fonts="from user_fonts.matrix7219 import *",`_matrix7219.show_text(${i}, USER_FONTS, USER_FONT_MAP, USER_FONT_WIDTH_INDEX)
`;let C="";if(this.definitions_.user_fonts)C=this.definitions_.user_fonts,C=C.slice(C.indexOf('USER_FONT_MAP = "')+17,C.lastIndexOf('"'));let u=l(C+X);return this.definitions_.user_fonts=u.content,`_matrix7219.show_text(${i}, USER_FONTS, USER_FONT_MAP, USER_FONT_WIDTH_INDEX)
`}return`_matrix7219.show_text(${i})
`}},{id:"clear",text:F(E,{id:"blocks.matrix7219.clear",defaultMessage:"clear device [IDX]"}),inputs:{IDX:{type:"positive_integer",defaultValue:"1"}},ino(d){return`_matrix7219.clearDisplay(${this.getAdjusted(d,"IDX")});
`},mpy(d){return`_matrix7219.clear_display(${this.getAdjusted(d,"IDX")})
`}},{id:"clearall",text:F(E,{id:"blocks.matrix7219.clearall",defaultMessage:"clear all devices"}),ino(d){let i="";return i+=`for (int i=0; i< _matrix7219.getDeviceCount(); i++)
`,i+=`  _matrix7219.clearDisplay(i);
`,i},mpy(d){return`_matrix7219.clear_display()
`}},"---",{id:"brightness",text:F(E,{id:"blocks.matrix7219.brightness",defaultMessage:"set device [IDX] brightness [LEVEL]"}),inputs:{IDX:{type:"positive_integer",defaultValue:1},LEVEL:{shadow:"brightnessLevel",defaultValue:"8"}},ino(d){let i=this.getAdjusted(d,"IDX"),X=this.valueToCode(d,"LEVEL",this.ORDER_NONE);return`_matrix7219.setIntensity(${i}, ${X});
`},mpy(d){let i=this.getAdjusted(d,"IDX"),X=this.valueToCode(d,"LEVEL",this.ORDER_NONE);return`_matrix7219.set_intensity(${i}, ${X})
`}},{id:"brightnessall",text:F(E,{id:"blocks.matrix7219.brightnessall",defaultMessage:"set all devices brightness [LEVEL]"}),inputs:{LEVEL:{shadow:"brightnessLevel",defaultValue:"8"}},ino(d){let i=this.valueToCode(d,"LEVEL",this.ORDER_NONE),X="";return X+=`for (int i=0; i< _matrix7219.getDeviceCount(); i++)
`,X+=`  _matrix7219.setIntensity(i, ${i});
`,X},mpy(d){let i=this.valueToCode(d,"LEVEL",this.ORDER_NONE),X="";return X+=`for i in range(_matrix7219.get_device_count()):
`,X+=`  _matrix7219.set_intensity(i, ${i})
`,X}},{id:"brightnessLevel",shadow:!0,output:"number",inputs:{LEVEL:{type:"slider",defaultValue:0,min:0,max:15}},mpy(d){return[d.getFieldValue("LEVEL")||0,this.ORDER_NONE]},ino(d){return[d.getFieldValue("LEVEL")||0,this.ORDER_NONE]}}],w={iotOutPins:{items:[["P0","33"],["P1","32"],["P5","0"],["P6","16"],["P7","17"],["P8","26"],["P9","25"],["P11","2"],["P13","18"],["P14","19"],["P15","21"],["P16","5"],["P19","22"],["P20","23"],["P23","27"],["P24","14"],["P25","12"],["P26","13"],["P27","15"],["P28","4"]]}};var m="./assets/fonts8x8-s5dfpbc6.h";var _="./assets/matrix7219-5bj935dp.h";var b="./assets/matrix7219-c70n0524.cpp";var H="./assets/matrix7219-1sq7nvp8.py";var v=(p)=>{if(p.editor==="@blockcode/gui-arduino")return[{header:!0,name:"matrix7219.h",type:"text/x-c",uri:_},{name:"matrix7219.cpp",type:"text/x-c",uri:b},{name:"fonts8x8.h",type:"text/x-c",uri:m}];return[{name:"matrix7219",type:"text/x-python",uri:H}]};var k={en:{"blocks.matrix7219.name":"MAX7219 Matrix","blocks.matrix7219.fontCreator":"Font Creator","blocks.matrix7219.fontCreatorLabel":"Enter the non-English characters(max {count}) to add to the font:","blocks.matrix7219.fontCreatorPlaceholder":"Enter characters...","blocks.matrix7219.init":"set pins CLK[CLK] DIN[DIN] CS[CS]","blocks.matrix7219.devices":"set matrix devices [NUM]","blocks.matrix7219.display":"display [MATRIX] on device [IDX]","blocks.matrix7219.text":"display [MSG]","blocks.matrix7219.rotate":"rotate device [IDX] to [ANGLE]","blocks.matrix7219.brightness":"set device [IDX] brightness [LEVEL]","blocks.matrix7219.brightnessall":"set all devices brightness [LEVEL]","blocks.matrix7219.clear":"clear device [IDX]","blocks.matrix7219.clearall":"clear all devices"},"zh-Hans":{"blocks.matrix7219.name":"MAX7219 灯点阵","blocks.matrix7219.fontCreator":"自定义字库","blocks.matrix7219.fontCreatorLabel":"请输入字库包含的非英文字符（最多 {count} 个）：","blocks.matrix7219.fontCreatorPlaceholder":"输入字符…","blocks.matrix7219.init":"初始引脚 CLK[CLK] DIN[DIN] CS[CS]","blocks.matrix7219.devices":"初始屏数 [NUM]","blocks.matrix7219.display":"在第[IDX]屏显示[MATRIX]","blocks.matrix7219.text":"显示[MSG]","blocks.matrix7219.rotate":"将第[IDX]屏旋转[ANGLE]","blocks.matrix7219.brightness":"将第[IDX]屏亮度设为[LEVEL]","blocks.matrix7219.brightnessall":"将所有屏亮度设为[LEVEL]","blocks.matrix7219.clear":"清除第[IDX]屏","blocks.matrix7219.clearall":"清除所有屏"},"zh-Hant":{"blocks.matrix7219.name":"MAX7219 燈點陣","blocks.matrix7219.fontCreator":"生成字庫","blocks.matrix7219.fontCreatorLabel":"請輸入字庫包含的非英文字符（最多 {count} 個）：","blocks.matrix7219.fontCreatorPlaceholder":"輸入字符…","blocks.matrix7219.init":"初始引腳 CLK[CLK] DIN[DIN] CS[CS]","blocks.matrix7219.devices":"初始屏數 [NUM]","blocks.matrix7219.display":"在第[IDX]屏顯示[MATRIX]","blocks.matrix7219.text":"顯示[MSG]","blocks.matrix7219.rotate":"將第[IDX]屏旋轉[ANGLE]","blocks.matrix7219.brightness":"將第[IDX]屏亮度設為[LEVEL]","blocks.matrix7219.brightnessall":"將所有屏亮度設為[LEVEL]","blocks.matrix7219.clear":"清除第[IDX]屏","blocks.matrix7219.clearall":"清除所有屏"}};var y="./assets/icon-ywrnbn6c.svg";var Z="./assets/icon-block-gadbsa57.svg";import{jsx as O}from"preact/jsx-runtime";N(k);var md={icon:y,blockIcon:Z,name:O(G,{id:"blocks.matrix7219.name",defaultMessage:"LED Matrix"}),files:v,blocks:L,menus:w};export{md as default};
