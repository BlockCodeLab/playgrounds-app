import{addLocalesMessages as R,Text as I}from"@blockcode/core";import{batch as g}from"@preact/signals";import{setMeta as q,addAsset as c,delAsset as P,openPromptModal as S,Text as E,translate as M}from"@blockcode/core";var l="./assets/quan-bz1kz289.ttf";var o="quan",x=8,$=new FontFace(o,`url(${l})`);document.fonts.add($);$.load();var s=(D)=>{let d=document.createElement("canvas").getContext("2d",{willReadFrequently:!0});d.font=`${x}px ${o}`,d.textAlign="left",d.textBaseline="top",d.fillStyle="#ffffff",d.fillRect(0,0,10,10),d.fillStyle="#000000",d.fillText(D,0,0);let{data:i}=d.getImageData(0,0,x,x),n=[],C=[];for(let p=0;p<i.length;p+=4)if(C.push(i[p]===0&&i[p+1]===0&&i[p+2]===0?1:0),C.length===x)n.push(C),C=[];let u=[];for(let p=0;p<x;p++){C=[];for(let A=0;A<x;A++)C.push(n[A][p]);u.push(`00${parseInt(C.join(""),2).toString(16)}`.slice(-2))}let B=u.length;for(let p=0;p<B;p++){if(u[0]!=="00")break;u.shift()}B=u.length;for(let p=0;p<B;p++){if(u.at(-1)!=="00")break;u.pop()}if(u.length===0)return;return u},e=(D)=>{let X=new Map,d=[],i=0,n="";D=D.trim();for(let B of D){if(B===" ")continue;let p=s(B);if(p){if(p.length>i)i=p.length;X.set(B,p)}}let C=`00${Math.ceil(i/2).toString(16)}`.slice(-2);n+=`  {${"0x00,".repeat(i)}0x${C}}, // 空格
`,d.push(" "),Array.from(X.entries()).forEach(([B,p])=>{let A="0x00,".repeat(i-p.length),f=`00${p.length.toString(16)}`.slice(-2),Z=`// ${B==="\\"?"backslash":B}`;n+=`  {0x${p.join(",0x")},${A}0x${f}}, ${Z}
`,d.push(B)});let u="";return u+=`static byte FONTS[${X.size+1}][${i+1}] = {
${n}};
`,u+=`static char *FONT_MAP[] = {"${d.map((B)=>B==='"'?"\\\"":B==="\\"?"\\\\":B).join('","')}"};
`,u+=`static int FONT_COUNT = ${X.size+1};
`,u+=`static int FONT_WIDTH_INDEX = ${i};
`,{content:u,map:d}},a=(D)=>{let X=new Map,d=[],i=0,n="";D=D.trim();for(let B of D){if(B===" ")continue;let p=s(B);if(p){if(p.length>i)i=p.length;X.set(B,p)}}let C=`00${Math.ceil(i/2).toString(16)}`.slice(-2);n+=`  b"${"\\x00".repeat(i)}\\x${C}", # 空格
`,d.push(" "),Array.from(X.entries()).forEach(([B,p])=>{let A="\\x00".repeat(i-p.length),f=`00${p.length.toString(16)}`.slice(-2);n+=`  b"\\x${p.join("\\x")}${A}\\x${f}", # ${B}
`,d.push(B)});let u=`USER_FONTS = (
${n})
`;return u+=`USER_FONT_WIDTH_INDEX = ${i}
`,u+=`USER_FONT_MAP = "${d.join("").replace('"',"\\\"")}"
`,{content:u,map:d}};function r(D){let X=globalThis.document,d=X.createElement("style");d.appendChild(X.createTextNode(D)),X.head.append(d)}r(".rbBgHG_text-input{border:1px solid var(--ui-black-transparent);width:30rem;color:var(--text-primary);resize:none;border-radius:5px;padding:.5rem;font-size:.875rem}");var h={textInput:"rbBgHG_text-input"};import{jsx as F}from"preact/jsx-runtime";var t=(D)=>D.editor==="@blockcode/gui-iotbit",T=(D)=>[{button:"FONT_CREATOR",text:F(E,{id:"blocks.matrix7219.fontCreator",defaultMessage:"Font Creator"}),onClick(){return new Promise((X)=>{S({title:F(E,{id:"blocks.matrix7219.fontCreator",defaultMessage:"Font Creator"}),label:F(E,{id:"blocks.matrix7219.fontCreatorLabel",defaultMessage:"Enter the non-English characters to add to the fonts: (max {count})",count:127}),body:F("textarea",{id:"matrix7219_font_creator",rows:"5",maxLength:"127",className:h.textInput,placeholder:M("blocks.matrix7219.fontCreatorPlaceholder","Enter characters..."),children:D.users?.fonts?.trim()??""}),onSubmit(){let d=D.editor==="@blockcode/gui-arduino",i=document.getElementById("matrix7219_font_creator").value,n=i?d?`#pragma once
#include <Arduino.h>
${e(i)}`:a(i):{map:[],content:""};g(()=>{if(q({users:{...D.users??{},fonts:n.map.join("")}}),d)i?c({id:"user_fonts.h",name:"user_fonts",type:"text/x-c",content:n.content}):P("user_fonts.h");else i?c({id:"/lib/user_fonts/matrix7219",name:"user_fonts",type:"text/x-python",content:n.content}):P("/lib/user_fonts/matrix7219");X(!0)})}})})}},{id:"init",text:F(E,{id:"blocks.matrix7219.init",defaultMessage:"set pins CLK[CLK] DIN[DIN] CS[CS]"}),inputs:{CLK:t(D)?{menu:"iotOutPins",defaultValue:"P5"}:{type:"positive_integer",defaultValue:2},DIN:t(D)?{menu:"iotOutPins",defaultValue:"P6"}:{type:"positive_integer",defaultValue:3},CS:t(D)?{menu:"iotOutPins",defaultValue:"P7"}:{type:"positive_integer",defaultValue:4}},ino(X){let d=this.valueToCode(X,"CLK",this.ORDER_NONE),i=this.valueToCode(X,"DIN",this.ORDER_NONE),n=this.valueToCode(X,"CS",this.ORDER_NONE),C=this.definitions_.variable_matrix7219_devices?.replace("// MAX7219 devices: ","")||1;return delete this.definitions_.variable_matrix7219_devices,this.definitions_.variable_matrix7219=`Matrix7219 _matrix7219(${d}, ${i}, ${n}, ${C});`,""},mpy(X){let d=t(D)?X.getFieldValue("CLK"):this.valueToCode(X,"CLK",this.ORDER_NONE),i=t(D)?X.getFieldValue("DIN"):this.valueToCode(X,"DIN",this.ORDER_NONE),n=t(D)?X.getFieldValue("CS"):this.valueToCode(X,"CS",this.ORDER_NONE),C=this.definitions_.matrix7219_devices?.replace("# MAX7219 devices: ","")||1;return delete this.definitions_.matrix7219_devices,this.definitions_.matrix7219=`_matrix7219 = matrix7219.Matrix7219(${d}, ${i}, ${n}, ${C})`,""}},{id:"devices",text:F(E,{id:"blocks.matrix7219.devices",defaultMessage:"set matrix devices [NUM]"}),inputs:{NUM:{type:"positive_integer",defaultValue:"1"}},ino(X){let d=this.valueToCode(X,"NUM",this.ORDER_NONE);if(this.definitions_.variable_matrix7219)this.definitions_.variable_matrix7219=this.definitions_.variable_matrix7219.replace(/\d+\);$/,`${d});`);else this.definitions_.variable_matrix7219_devices=`// MAX7219 devices: ${d}`;return""},mpy(X){let d=this.valueToCode(X,"NUM",this.ORDER_NONE);if(this.definitions_.matrix7219)this.definitions_.matrix7219=this.definitions_.matrix7219.replace(/\d+\)$/,`${d})`);else this.definitions_.matrix7219_devices=`# MAX7219 devices: ${d}`;return""}},"---",{id:"display",text:F(E,{id:"blocks.matrix7219.display",defaultMessage:"display [MATRIX] on device [IDX]"}),inputs:{MATRIX:{shadow:"matrix88",defaultValue:"0000000001100110111111111111111111111111011111100011110000011000"},IDX:{type:"positive_integer",defaultValue:1}},ino(X){let d=this.getAdjusted(X,"IDX"),i=this.valueToCode(X,"MATRIX",this.ORDER_NONE);return`_matrix7219.showMatrix(${d}, (byte[]){${i}});
`},mpy(X){let d=this.getAdjusted(X,"IDX"),i=this.valueToCode(X,"MATRIX",this.ORDER_NONE),n="";return n+=`_matrix7219.show_matrix(${d}, b"${i}")
`,n}},{id:"matrix88",shadow:!0,output:"string",inputs:{MATRIX:{type:"matrix",width:8,height:8}},ino(X){let d=X.getFieldValue("MATRIX"),i=[];for(let n=0;n<8;n++){let C=d.slice(n*8,(n+1)*8),u=`00${parseInt(C,2).toString(16)}`.slice(-2);i.push(u)}return[`0x${i.join(",0x")}`,this.ORDER_ATOMIC]},mpy(X){let d=X.getFieldValue("MATRIX"),i=[];for(let n=0;n<8;n++){let C=d.slice(n*8,(n+1)*8),u=`00${parseInt(C,2).toString(16)}`.slice(-2);i.push(u)}return[`\\x${i.join("\\x")}`,this.ORDER_ATOMIC]}},{id:"text",text:F(E,{id:"blocks.matrix7219.text",defaultMessage:"display [MSG]"}),inputs:{MSG:{type:"string",defaultValue:"abc"}},ino(X){let i=this.valueToCode(X,"MSG",this.ORDER_NONE).replace(/^['"]/,"").replace(/['"]$/,""),n=i.split("").map((u)=>`"${u==='"'?"\\\"":u==="\\"?"\\\\":u}"`);if(/[^\x20-\x7E]/.test(i)){if(delete this.definitions_.include_user_fonts,D.users?.fonts)return this.definitions_.include_user_fonts='#include "user_fonts.h"',`SHOW_TEXT(_matrix7219, ${n});
`;let u="";if(this.definitions_.variable_user_fonts)u=this.definitions_.variable_user_fonts,u=u.slice(u.indexOf('static char *USER_FONT_MAP[] = {"')+33,u.lastIndexOf('"};')),u=u.replaceAll('","',"");let B=e(u+i);return this.definitions_.variable_user_fonts=B.content,`SHOW_TEXT(_matrix7219, ${n});
`}return this.definitions_.include_user_fonts='#include "fonts8x8.h"',`SHOW_TEXT(_matrix7219, ${n});
`},mpy(X){let d=this.valueToCode(X,"MSG",this.ORDER_NONE),i=d.replace(/^['"]/,"").replace(/['"]$/,"");if(/[^\x20-\x7E]/.test(i)){if(D.users?.fonts)return this.definitions_.import_user_fonts="from user_fonts.matrix7219 import *",`_matrix7219.show_text(${d}, USER_FONTS, USER_FONT_MAP, USER_FONT_WIDTH_INDEX)
`;let C="";if(this.definitions_.user_fonts)C=this.definitions_.user_fonts,C=C.slice(C.indexOf('USER_FONT_MAP = "')+17,C.lastIndexOf('"'));let u=a(C+i);return this.definitions_.user_fonts=u.content,`_matrix7219.show_text(${d}, USER_FONTS, USER_FONT_MAP, USER_FONT_WIDTH_INDEX)
`}return`_matrix7219.show_text(${d})
`}},{id:"clear",text:F(E,{id:"blocks.matrix7219.clear",defaultMessage:"clear device [IDX]"}),inputs:{IDX:{type:"positive_integer",defaultValue:"1"}},ino(X){return`_matrix7219.clearDisplay(${this.getAdjusted(X,"IDX")});
`},mpy(X){return`_matrix7219.clear_display(${this.getAdjusted(X,"IDX")})
`}},{id:"clearall",text:F(E,{id:"blocks.matrix7219.clearall",defaultMessage:"clear all devices"}),ino(X){let d="";return d+=`for (int i=0; i< _matrix7219.getDeviceCount(); i++)
`,d+=`  _matrix7219.clearDisplay(i);
`,d},mpy(X){return`_matrix7219.clear_display()
`}},"---",{id:"brightness",text:F(E,{id:"blocks.matrix7219.brightness",defaultMessage:"set device [IDX] brightness [LEVEL]"}),inputs:{IDX:{type:"positive_integer",defaultValue:1},LEVEL:{shadow:"brightnessLevel",defaultValue:"8"}},ino(X){let d=this.getAdjusted(X,"IDX"),i=this.valueToCode(X,"LEVEL",this.ORDER_NONE);return`_matrix7219.setIntensity(${d}, ${i});
`},mpy(X){let d=this.getAdjusted(X,"IDX"),i=this.valueToCode(X,"LEVEL",this.ORDER_NONE);return`_matrix7219.set_intensity(${d}, ${i})
`}},{id:"brightnessall",text:F(E,{id:"blocks.matrix7219.brightnessall",defaultMessage:"set all devices brightness [LEVEL]"}),inputs:{LEVEL:{shadow:"brightnessLevel",defaultValue:"8"}},ino(X){let d=this.valueToCode(X,"LEVEL",this.ORDER_NONE),i="";return i+=`for (int i=0; i< _matrix7219.getDeviceCount(); i++)
`,i+=`  _matrix7219.setIntensity(i, ${d});
`,i},mpy(X){let d=this.valueToCode(X,"LEVEL",this.ORDER_NONE),i="";return i+=`for i in range(_matrix7219.get_device_count()):
`,i+=`  _matrix7219.set_intensity(i, ${d})
`,i}},{id:"brightnessLevel",shadow:!0,output:"number",inputs:{LEVEL:{type:"slider",defaultValue:0,min:0,max:15}},mpy(X){return[X.getFieldValue("LEVEL")||0,this.ORDER_NONE]},ino(X){return[X.getFieldValue("LEVEL")||0,this.ORDER_NONE]}}],L={iotOutPins:{items:[["P0","33"],["P1","32"],["P5","0"],["P6","16"],["P7","17"],["P8","26"],["P9","25"],["P11","2"],["P13","18"],["P14","19"],["P15","21"],["P16","5"],["P19","22"],["P20","23"],["P23","27"],["P24","14"],["P25","12"],["P26","13"],["P27","15"],["P28","4"]]}};var w="./assets/fonts8x8-s5dfpbc6.h";var m="./assets/matrix7219-5bj935dp.h";var _="./assets/matrix7219-c70n0524.cpp";var b="./assets/matrix7219-1sq7nvp8.py";var H=(D)=>{if(D.editor==="@blockcode/gui-arduino")return[{header:!0,name:"matrix7219.h",type:"text/x-c",uri:m},{name:"matrix7219.cpp",type:"text/x-c",uri:_},{name:"fonts8x8.h",type:"text/x-c",uri:w}];return[{name:"matrix7219",type:"text/x-python",uri:b}]};var v={en:{"blocks.matrix7219.name":"MAX7219 Matrix","blocks.matrix7219.fontCreator":"Font Creator","blocks.matrix7219.fontCreatorLabel":"Enter the non-English characters(max {count}) to add to the font:","blocks.matrix7219.fontCreatorPlaceholder":"Enter characters...","blocks.matrix7219.init":"set pins CLK[CLK] DIN[DIN] CS[CS]","blocks.matrix7219.devices":"set matrix devices [NUM]","blocks.matrix7219.display":"display [MATRIX] on device [IDX]","blocks.matrix7219.text":"display [MSG]","blocks.matrix7219.rotate":"rotate device [IDX] to [ANGLE]","blocks.matrix7219.brightness":"set device [IDX] brightness [LEVEL]","blocks.matrix7219.brightnessall":"set all devices brightness [LEVEL]","blocks.matrix7219.clear":"clear device [IDX]","blocks.matrix7219.clearall":"clear all devices"},"zh-Hans":{"blocks.matrix7219.name":"MAX7219 灯点阵","blocks.matrix7219.fontCreator":"自定义字库","blocks.matrix7219.fontCreatorLabel":"请输入字库包含的非英文字符（最多 {count} 个）：","blocks.matrix7219.fontCreatorPlaceholder":"输入字符…","blocks.matrix7219.init":"初始引脚 CLK[CLK] DIN[DIN] CS[CS]","blocks.matrix7219.devices":"初始屏数 [NUM]","blocks.matrix7219.display":"在第[IDX]屏显示[MATRIX]","blocks.matrix7219.text":"显示[MSG]","blocks.matrix7219.rotate":"将第[IDX]屏旋转[ANGLE]","blocks.matrix7219.brightness":"将第[IDX]屏亮度设为[LEVEL]","blocks.matrix7219.brightnessall":"将所有屏亮度设为[LEVEL]","blocks.matrix7219.clear":"清除第[IDX]屏","blocks.matrix7219.clearall":"清除所有屏"},"zh-Hant":{"blocks.matrix7219.name":"MAX7219 燈點陣","blocks.matrix7219.fontCreator":"生成字庫","blocks.matrix7219.fontCreatorLabel":"請輸入字庫包含的非英文字符（最多 {count} 個）：","blocks.matrix7219.fontCreatorPlaceholder":"輸入字符…","blocks.matrix7219.init":"初始引腳 CLK[CLK] DIN[DIN] CS[CS]","blocks.matrix7219.devices":"初始屏數 [NUM]","blocks.matrix7219.display":"在第[IDX]屏顯示[MATRIX]","blocks.matrix7219.text":"顯示[MSG]","blocks.matrix7219.rotate":"將第[IDX]屏旋轉[ANGLE]","blocks.matrix7219.brightness":"將第[IDX]屏亮度設為[LEVEL]","blocks.matrix7219.brightnessall":"將所有屏亮度設為[LEVEL]","blocks.matrix7219.clear":"清除第[IDX]屏","blocks.matrix7219.clearall":"清除所有屏"}};var k="./assets/icon-ywrnbn6c.svg";var y="./assets/icon-block-gadbsa57.svg";import{jsx as N}from"preact/jsx-runtime";R(v);var Ld={icon:k,blockIcon:y,name:N(I,{id:"blocks.matrix7219.name",defaultMessage:"LED Matrix"}),files:H,blocks:T,menus:L};export{Ld as default};
