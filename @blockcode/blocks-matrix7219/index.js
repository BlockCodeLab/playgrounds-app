import{addLocalesMessages as j,Text as R}from"@blockcode/core";import{batch as g}from"@preact/signals";import{setMeta as q,addAsset as c,delAsset as P,openPromptModal as S,Text as E,translate as M}from"@blockcode/core";var o="./assets/quan-bz1kz289.ttf";var $="quan",x=8,e=new FontFace($,`url(${o})`);document.fonts.add(e);e.load();var z=document.createElement("canvas"),A=z.getContext("2d",{willReadFrequently:!0});e.loaded.then(()=>{A.font=`${x}px ${$}`,A.textAlign="left",A.textBaseline="top"}).catch((C)=>{console.log(C)});var s=(C)=>{A.fillStyle="#ffffff",A.fillRect(0,0,10,10),A.fillStyle="#000000",A.fillText(C,0,0);let{data:d}=A.getImageData(0,0,x,x),i=[],X=[];for(let u=0;u<d.length;u+=4)if(X.push(d[u]===0&&d[u+1]===0&&d[u+2]===0?1:0),X.length===x)i.push(X),X=[];let n=[];for(let u=0;u<x;u++){X=[];for(let p=0;p<x;p++)X.push(i[p][u]);n.push(`00${parseInt(X.join(""),2).toString(16)}`.slice(-2))}let D=n.length;for(let u=0;u<D;u++){if(n[0]!=="00")break;n.shift()}D=n.length;for(let u=0;u<D;u++){if(n.at(-1)!=="00")break;n.pop()}if(n.length===0)return;return n},a=(C)=>{let d=new Map,i=[],X=0,n="";C=C.trim();for(let p of C){if(p===" ")continue;let B=s(p);if(B){if(B.length>X)X=B.length;d.set(p,B)}}let D=`00${Math.ceil(X/2).toString(16)}`.slice(-2);n+=`  {${"0x00,".repeat(X)}0x${D}}, // 空格
`,i.push(" "),Array.from(d.entries()).forEach(([p,B])=>{let t="0x00,".repeat(X-B.length),f=`00${B.length.toString(16)}`.slice(-2),y=`// ${p==="\\"?"backslash":p}`;n+=`  {0x${B.join(",0x")},${t}0x${f}}, ${y}
`,i.push(p)});let u=`#pragma once
`;return u+=`#include <Arduino.h>
`,u+=`static byte FONTS[${d.size+1}][${X+1}] = {
${n}};
`,u+=`static char *FONT_MAP[] = {"${i.map((p)=>p==='"'?"\\\"":p==="\\"?"\\\\":p).join('","')}"};
`,u+=`static int FONT_COUNT = ${d.size+1};
`,u+=`static int FONT_WIDTH_INDEX = ${X};
`,{content:u,map:i}},r=(C)=>{let d=new Map,i=[],X=0,n="";C=C.trim();for(let p of C){if(p===" ")continue;let B=s(p);if(B){if(B.length>X)X=B.length;d.set(p,B)}}let D=`00${Math.ceil(X/2).toString(16)}`.slice(-2);n+=`  b"${"\\x00".repeat(X)}\\x${D}", # 空格
`,i.push(" "),Array.from(d.entries()).forEach(([p,B])=>{let t="\\x00".repeat(X-B.length),f=`00${B.length.toString(16)}`.slice(-2);n+=`  b"\\x${B.join("\\x")}${t}\\x${f}", # ${p}
`,i.push(p)});let u=`USER_FONTS = (
${n})
`;return u+=`USER_FONT_WIDTH_INDEX = ${X}
`,u+=`USER_FONT_MAP = "${i.join("").replace('"',"\\\"")}"
`,{content:u,map:i}};function l(C){let d=globalThis.document,i=d.createElement("style");i.appendChild(d.createTextNode(C)),d.head.append(i)}l(".rbBgHG_text-input{border:1px solid var(--ui-black-transparent);width:30rem;color:var(--text-primary);resize:none;border-radius:5px;padding:.5rem;font-size:.875rem}");var h={textInput:"rbBgHG_text-input"};import{jsx as F}from"preact/jsx-runtime";var T=(C)=>[{button:"FONT_CREATOR",text:F(E,{id:"blocks.matrix7219.fontCreator",defaultMessage:"Font Creator"}),onClick(){return new Promise((d)=>{S({title:F(E,{id:"blocks.matrix7219.fontCreator",defaultMessage:"Font Creator"}),label:F(E,{id:"blocks.matrix7219.fontCreatorLabel",defaultMessage:"Enter the non-English characters to add to the fonts: (max {count})",count:127}),body:F("textarea",{id:"matrix7219_font_creator",rows:"5",maxLength:"127",className:h.textInput,placeholder:M("blocks.matrix7219.fontCreatorPlaceholder","Enter characters..."),children:C.users?.fonts?.trim()??""}),onSubmit(){let i=C.editor==="@blockcode/gui-arduino",X=document.getElementById("matrix7219_font_creator").value,n=X?i?a(X):r(X):{map:[],content:""};g(()=>{if(q({users:{...C.users??{},fonts:n.map.join("")}}),i)X?c({id:"user_fonts.h",name:"user_fonts",type:"text/x-c",content:n.content}):P("user_fonts.h");else X?c({id:"/lib/user_fonts/matrix7219",name:"user_fonts",type:"text/x-python",content:n.content}):P("/lib/user_fonts/matrix7219");d(!0)})}})})}},{id:"init",text:F(E,{id:"blocks.matrix7219.init",defaultMessage:"set pins CLK[CLK] DIN[DIN] CS[CS]"}),inputs:{CLK:{type:"integer",defaultValue:"2"},DIN:{type:"integer",defaultValue:"3"},CS:{type:"integer",defaultValue:"4"}},ino(d){let i=this.valueToCode(d,"CLK",this.ORDER_NONE),X=this.valueToCode(d,"DIN",this.ORDER_NONE),n=this.valueToCode(d,"CS",this.ORDER_NONE),D=this.definitions_.variable_matrix7219_devices?.replace("// MAX7219 devices: ","")||1;return delete this.definitions_.variable_matrix7219_devices,this.definitions_.variable_matrix7219=`Matrix7219 _matrix7219(${i}, ${X}, ${n}, ${D});`,""},mpy(d){let i=this.valueToCode(d,"CLK",this.ORDER_NONE),X=this.valueToCode(d,"DIN",this.ORDER_NONE),n=this.valueToCode(d,"CS",this.ORDER_NONE),D=this.definitions_.matrix7219_devices?.replace("# MAX7219 devices: ","")||1;return delete this.definitions_.matrix7219_devices,this.definitions_.matrix7219=`_matrix7219 = matrix7219.Matrix7219(${i}, ${X}, ${n}, ${D})`,""}},{id:"devices",text:F(E,{id:"blocks.matrix7219.devices",defaultMessage:"set matrix devices [NUM]"}),inputs:{NUM:{type:"positive_integer",defaultValue:"1"}},ino(d){let i=this.valueToCode(d,"NUM",this.ORDER_NONE);if(this.definitions_.variable_matrix7219)this.definitions_.variable_matrix7219=this.definitions_.variable_matrix7219.replace(/\d+\);$/,`${i});`);else this.definitions_.variable_matrix7219_devices=`// MAX7219 devices: ${i}`;return""},mpy(d){let i=this.valueToCode(d,"NUM",this.ORDER_NONE);if(this.definitions_.matrix7219)this.definitions_.matrix7219=this.definitions_.matrix7219.replace(/\d+\)$/,`${i})`);else this.definitions_.matrix7219_devices=`# MAX7219 devices: ${i}`;return""}},"---",{id:"display",text:F(E,{id:"blocks.matrix7219.display",defaultMessage:"display [MATRIX] on device [IDX]"}),inputs:{MATRIX:{shadow:"matrix88",defaultValue:"0000000001100110111111111111111111111111011111100011110000011000"},IDX:{type:"positive_integer",defaultValue:1}},ino(d){let i=this.getAdjusted(d,"IDX"),X=this.valueToCode(d,"MATRIX",this.ORDER_NONE);return`_matrix7219.showMatrix(${i}, (byte[]){${X}});
`},mpy(d){let i=this.getAdjusted(d,"IDX"),X=this.valueToCode(d,"MATRIX",this.ORDER_NONE),n="";return n+=`_matrix7219.show_matrix(${i}, b"${X}")
`,n}},{id:"matrix88",shadow:!0,output:"string",inputs:{MATRIX:{type:"matrix",width:8,height:8}},ino(d){let i=d.getFieldValue("MATRIX"),X=[];for(let n=0;n<8;n++){let D=i.slice(n*8,(n+1)*8),u=`00${parseInt(D,2).toString(16)}`.slice(-2);X.push(u)}return[`0x${X.join(",0x")}`,this.ORDER_ATOMIC]},mpy(d){let i=d.getFieldValue("MATRIX"),X=[];for(let n=0;n<8;n++){let D=i.slice(n*8,(n+1)*8),u=`00${parseInt(D,2).toString(16)}`.slice(-2);X.push(u)}return[`\\x${X.join("\\x")}`,this.ORDER_ATOMIC]}},{id:"text",text:F(E,{id:"blocks.matrix7219.text",defaultMessage:"display [MSG]"}),inputs:{MSG:{type:"string",defaultValue:"abc"}},ino(d){let X=this.valueToCode(d,"MSG",this.ORDER_NONE).replace(/^['"]/,"").replace(/['"]$/,""),n=X.split("").map((u)=>`"${u==='"'?"\\\"":u==="\\"?"\\\\":u}"`);if(/[^\x20-\x7E]/.test(X)){if(delete this.definitions_.include_user_fonts,C.users?.fonts)return this.definitions_.include_user_fonts='#include "user_fonts.h"',`SHOW_TEXT(_matrix7219, ${n});
`;let u="";if(this.definitions_.variable_user_fonts)u=this.definitions_.variable_user_fonts,u=u.slice(u.indexOf('static char *USER_FONT_MAP[] = {"')+33,u.lastIndexOf('"};')),u=u.replaceAll('","',"");let p=a(u+X);return this.definitions_.variable_user_fonts=p.content,`SHOW_TEXT(_matrix7219, ${n});
`}return this.definitions_.include_user_fonts='#include "fonts8x8.h"',`SHOW_TEXT(_matrix7219, ${n});
`},mpy(d){let i=this.valueToCode(d,"MSG",this.ORDER_NONE),X=i.replace(/^['"]/,"").replace(/['"]$/,"");if(/[^\x20-\x7E]/.test(X)){if(C.users?.fonts)return this.definitions_.import_user_fonts="from user_fonts.matrix7219 import *",`_matrix7219.show_text(${i}, USER_FONTS, USER_FONT_MAP, USER_FONT_WIDTH_INDEX)
`;let D="";if(this.definitions_.user_fonts)D=this.definitions_.user_fonts,D=D.slice(D.indexOf('USER_FONT_MAP = "')+17,D.lastIndexOf('"'));let u=r(D+X);return this.definitions_.user_fonts=u.content,`_matrix7219.show_text(${i}, USER_FONTS, USER_FONT_MAP, USER_FONT_WIDTH_INDEX)
`}return`_matrix7219.show_text(${i})
`}},{id:"clear",text:F(E,{id:"blocks.matrix7219.clear",defaultMessage:"clear device [IDX]"}),inputs:{IDX:{type:"positive_integer",defaultValue:"1"}},ino(d){return`_matrix7219.clearDisplay(${this.getAdjusted(d,"IDX")});
`},mpy(d){return`_matrix7219.clear_display(${this.getAdjusted(d,"IDX")})
`}},{id:"clearall",text:F(E,{id:"blocks.matrix7219.clearall",defaultMessage:"clear all devices"}),ino(d){let i="";return i+=`for (int i=0; i< _matrix7219.getDeviceCount(); i++)
`,i+=`  _matrix7219.clearDisplay(i);
`,i},mpy(d){return`_matrix7219.clear_display()
`}},"---",{id:"brightness",text:F(E,{id:"blocks.matrix7219.brightness",defaultMessage:"set device [IDX] brightness [LEVEL]"}),inputs:{IDX:{type:"positive_integer",defaultValue:1},LEVEL:{shadow:"brightnessLevel",defaultValue:"8"}},ino(d){let i=this.getAdjusted(d,"IDX"),X=this.valueToCode(d,"LEVEL",this.ORDER_NONE);return`_matrix7219.setIntensity(${i}, ${X});
`},mpy(d){let i=this.getAdjusted(d,"IDX"),X=this.valueToCode(d,"LEVEL",this.ORDER_NONE);return`_matrix7219.set_intensity(${i}, ${X})
`}},{id:"brightnessall",text:F(E,{id:"blocks.matrix7219.brightnessall",defaultMessage:"set all devices brightness [LEVEL]"}),inputs:{LEVEL:{shadow:"brightnessLevel",defaultValue:"8"}},ino(d){let i=this.valueToCode(d,"LEVEL",this.ORDER_NONE),X="";return X+=`for (int i=0; i< _matrix7219.getDeviceCount(); i++)
`,X+=`  _matrix7219.setIntensity(i, ${i});
`,X},mpy(d){let i=this.valueToCode(d,"LEVEL",this.ORDER_NONE),X="";return X+=`for i in range(_matrix7219.get_device_count()):
`,X+=`  _matrix7219.set_intensity(i, ${i})
`,X}},{id:"brightnessLevel",shadow:!0,output:"number",inputs:{LEVEL:{type:"slider",defaultValue:0,min:0,max:15}},mpy(d){return[d.getFieldValue("LEVEL")||0,this.ORDER_NONE]},ino(d){return[d.getFieldValue("LEVEL")||0,this.ORDER_NONE]}}];var L="./assets/fonts8x8-s5dfpbc6.h";var m="./assets/matrix7219-5bj935dp.h";var w="./assets/matrix7219-c70n0524.cpp";var b="./assets/matrix7219-1sq7nvp8.py";var _=(C)=>{if(C.editor==="@blockcode/gui-arduino")return[{header:!0,name:"matrix7219.h",type:"text/x-c",uri:m},{name:"matrix7219.cpp",type:"text/x-c",uri:w},{name:"fonts8x8.h",type:"text/x-c",uri:L}];return[{name:"matrix7219",type:"text/x-python",uri:b}]};var H={en:{"blocks.matrix7219.name":"MAX7219 Matrix","blocks.matrix7219.fontCreator":"Font Creator","blocks.matrix7219.fontCreatorLabel":"Enter the non-English characters(max {count}) to add to the font:","blocks.matrix7219.fontCreatorPlaceholder":"Enter characters...","blocks.matrix7219.init":"set pins CLK[CLK] DIN[DIN] CS[CS]","blocks.matrix7219.devices":"set matrix devices [NUM]","blocks.matrix7219.display":"display [MATRIX] on device [IDX]","blocks.matrix7219.text":"display [MSG]","blocks.matrix7219.rotate":"rotate device [IDX] to [ANGLE]","blocks.matrix7219.brightness":"set device [IDX] brightness [LEVEL]","blocks.matrix7219.brightnessall":"set all devices brightness [LEVEL]","blocks.matrix7219.clear":"clear device [IDX]","blocks.matrix7219.clearall":"clear all devices"},"zh-Hans":{"blocks.matrix7219.name":"MAX7219 灯点阵","blocks.matrix7219.fontCreator":"自定义字库","blocks.matrix7219.fontCreatorLabel":"请输入字库包含的非英文字符（最多 {count} 个）：","blocks.matrix7219.fontCreatorPlaceholder":"输入字符…","blocks.matrix7219.init":"初始引脚 CLK[CLK] DIN[DIN] CS[CS]","blocks.matrix7219.devices":"初始屏数 [NUM]","blocks.matrix7219.display":"在第[IDX]屏显示[MATRIX]","blocks.matrix7219.text":"显示[MSG]","blocks.matrix7219.rotate":"将第[IDX]屏旋转[ANGLE]","blocks.matrix7219.brightness":"将第[IDX]屏亮度设为[LEVEL]","blocks.matrix7219.brightnessall":"将所有屏亮度设为[LEVEL]","blocks.matrix7219.clear":"清除第[IDX]屏","blocks.matrix7219.clearall":"清除所有屏"},"zh-Hant":{"blocks.matrix7219.name":"MAX7219 燈點陣","blocks.matrix7219.fontCreator":"生成字庫","blocks.matrix7219.fontCreatorLabel":"請輸入字庫包含的非英文字符（最多 {count} 個）：","blocks.matrix7219.fontCreatorPlaceholder":"輸入字符…","blocks.matrix7219.init":"初始引腳 CLK[CLK] DIN[DIN] CS[CS]","blocks.matrix7219.devices":"初始屏數 [NUM]","blocks.matrix7219.display":"在第[IDX]屏顯示[MATRIX]","blocks.matrix7219.text":"顯示[MSG]","blocks.matrix7219.rotate":"將第[IDX]屏旋轉[ANGLE]","blocks.matrix7219.brightness":"將第[IDX]屏亮度設為[LEVEL]","blocks.matrix7219.brightnessall":"將所有屏亮度設為[LEVEL]","blocks.matrix7219.clear":"清除第[IDX]屏","blocks.matrix7219.clearall":"清除所有屏"}};var v="./assets/icon-ywrnbn6c.svg";var k="./assets/icon-block-gadbsa57.svg";import{jsx as N}from"preact/jsx-runtime";j(H);var Ld={icon:v,blockIcon:k,name:N(R,{id:"blocks.matrix7219.name",defaultMessage:"LED Matrix"}),files:_,blocks:T};export{Ld as default};
