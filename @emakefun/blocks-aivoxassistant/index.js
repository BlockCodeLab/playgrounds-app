import{addLocalesMessages as T,Text as b}from"@blockcode/core";import{Text as c}from"@blockcode/core";import{jsx as m}from"preact/jsx-runtime";var v=(o)=>o.editor==="@blockcode/gui-arduino",h=(o)=>[{id:"init",text:m(c,{id:"blocks.aivoxassistant.init",defaultMessage:"set pins RX:[RX] TX:[TX]"}),inputs:{RX:o.boardPins?{menu:o.boardPins.all}:{type:"positive_integer",defaultValue:2},TX:o.boardPins?{menu:o.boardPins.all}:{type:"positive_integer",defaultValue:3}},ino(t){let s=o.boardPins?t.getFieldValue("RX"):this.valueToCode(t,"RX",this.ORDER_NONE),a=o.boardPins?t.getFieldValue("TX"):this.valueToCode(t,"TX",this.ORDER_NONE);return this.definitions_.include_softwareserial="#include <SoftwareSerial.h>",this.definitions_.variable_aivoxAssistant=`SoftwareSerial aivoxAssistant(${s}, ${a});`,this.definitions_.setup_aivoxAssistant="aivoxAssistant.begin(115200);",""},mpy(t){let s=o.boardPins?t.getFieldValue("RX"):this.valueToCode(t,"RX",this.ORDER_NONE),a=o.boardPins?t.getFieldValue("TX"):this.valueToCode(t,"TX",this.ORDER_NONE);return this.definitions_.import_uart="from machine import UART",this.definitions_.aivox_assistant=`aivox_assistant = UART(1, baudrate=115200, rx=${s}, tx=${a})`,""}},"---",{id:"whenCommand",text:m(c,{id:"blocks.aivoxassistant.whenCommand",defaultMessage:"when receive [CMD] command"}),hat:!0,inputs:{CMD:{type:"string",defaultValue:"turn on led"}},ino(t){if(this.definitions_.include_regexp="#include <Regexp.h>",this.definitions_.variable_commandReg="MatchState cmdRe;",!this.definitions_.processAssistant){let i="";i+=`void processAssistant() {
`,i+=`  if (aivoxAssistant.available() == 0) return;
`,i+=`  String cmd = aivoxAssistant.readStringUntil('\\n');
`,i+=`  cmdRe.Target(cmd.c_str());
`,i+="}",this.definitions_.processAssistant=i,this.definitions_.declare_processAssistant="void processAssistant();",this.definitions_.loop_processAssistant="processAssistant();"}let s=this.createName("assistantCommand"),a=this.statementToCode(t)||"";this.definitions_[`declare_${s}`]=`void ${s}();`,this.definitions_[s]=`void ${s}() {
${a}}`;let r=this.valueToCode(t,"CMD",this.ORDER_NONE).replace(/\{\S+\}/g,"(%S+)").replace(/\s+/g,"%s+");this.definitions_.processAssistant=this.definitions_.processAssistant.replace(`;
}`,`;
  if (cmdRe.Match(${r}) > 0) return ${s}();
}`)},mpy(t){if(this.definitions_.import_re="import re",this.definitions_.assistant_matched="assistant_matched = None",!this.definitions_.assistant_received){let n="";n+=`@_tasks__.append
`,n+=`async def assistant_received():
`,n+=`  global assistant_matched
`,n+=`  while True:
`,n+=`    await asyncio.sleep_ms(5)
`,n+=`    if not aivox_assistant.any(): continue
`,n+=`    cmd = aivox_assistant.readline()
`,this.definitions_.assistant_received=n}let s=this.createName("assistant_flag");this.definitions_[s]=`${s} = asyncio.ThreadSafeFlag()`;let a=this.statementToCode(t)||"",e="";e+=`global assistant_matched
`,e+=`while True:
`,e+=`  await ${s}.wait()
`,e+=a;let r=this.valueToCode(t,"CMD",this.ORDER_NONE),i=this.getFunctionName(r);a=this.prefixLines(e,this.INDENT),a=this.addEventTrap(a,"assistant_callback"),e=`@_tasks__.append
`,e+=a,this.definitions_[i]=e;let l=r.replace(/\{\S+\}/g,"(\\S+)").replace(/\s+/g,"\\s+");e="",e+=`    assistant_matched = re.match(${l}, cmd)
`,e+=`    if assistant_matched: ${s}.set(); continue
`,this.definitions_.assistant_received+=e}},{id:"argument",text:m(c,{id:"blocks.aivoxassistant.argument",defaultMessage:"[TYPE] argument [ARG] of command"}),output:"string",inputs:{TYPE:{menu:v(o)?"ArduinoTypes":"Types"},ARG:{type:"string",defaultValue:"x"}},ino(t){let s=t.getRootBlock();if(t.parentBlock_===s)return"";let a=JSON.parse(this.valueToCode(t,"ARG",this.ORDER_NONE)),e=this.valueToCode(s,"CMD",this.ORDER_NONE),r=t.getFieldValue("TYPE");this.definitions_.include_regexp="#include <Regexp.h>",this.definitions_.variable_commandReg="MatchState cmdRe;";let i="";i+=`String getCommandArgument(uint8_t idx) {
`,i+=`  char arg[100];
`,i+=`  cmdRe.GetCapture(arg, idx);
`,i+=`  return String(arg);
`,i+="}",this.definitions_.getCommandArgument=i,this.definitions_.declare_getCommandArgument="String getCommandArgument(uint8_t idx);";let l=0,n=[...e.matchAll(/\{(\w+)\}/g)];for(let d=0;d<n.length;d++)if(n[d][1]===a){l=d;break}let u="";if(r!=="String")u=`.to${r.charAt(0).toUpperCase()}${r.slice(1)}()`;return i=`getCommandArgument(${l})${u}`,[i]},mpy(t){let s=t.getRootBlock();if(t.parentBlock_===s)return"";let a=JSON.parse(this.valueToCode(t,"ARG",this.ORDER_NONE)),e=this.valueToCode(s,"CMD",this.ORDER_NONE),r=t.getFieldValue("TYPE");this.definitions_.import_re="import re",this.definitions_.assistant_matched="assistant_matched = None";let i=0,l=[...e.matchAll(/\{(\w+)\}/g)];for(let d=0;d<l.length;d++)if(l[d][1]===a){i=d+1;break}let n="float";if(r!=="float")n=r.slice(0,3).toLowerCase();return[`${n}(${n==="str"?'""':0} if not assistant_matched else assistant_matched.group(${i}))`]}}],g={Types:{items:[[m(c,{id:"blocks.aivoxassistant.argumentInt",defaultMessage:"int"}),"int"],[m(c,{id:"blocks.aivoxassistant.argumentFloat",defaultMessage:"float"}),"float"],[m(c,{id:"blocks.aivoxassistant.argumentString",defaultMessage:"string"}),"String"]]},ArduinoTypes:{items:["int","float","String"]}};var _="///docs.emakefun.com/#/zh-cn/ph2.0_sensors/smart_module/ai_voice_assistant/ai_voice_assistant";var f={en:{"blocks.aivoxassistant.name":"AI Vox Assistant","blocks.aivoxassistant.init":"set pins RX:[RX] TX:[TX]","blocks.aivoxassistant.whenCommand":"when receive [CMD] command","blocks.aivoxassistant.argument":"[TYPE] argument [ARG] of command","blocks.aivoxassistant.argumentInt":"integer","blocks.aivoxassistant.argumentFloat":"float","blocks.aivoxassistant.argumentString":"string"},"zh-Hans":{"blocks.aivoxassistant.name":"AI 语音助手","blocks.aivoxassistant.init":"初始引脚 RX:[RX] TX:[TX]","blocks.aivoxassistant.whenCommand":"当收到 [CMD] 指令时","blocks.aivoxassistant.argument":"指令参数 [ARG] 类型 [TYPE]","blocks.aivoxassistant.argumentInt":"整数","blocks.aivoxassistant.argumentFloat":"浮点数","blocks.aivoxassistant.argumentString":"字符串"},"zh-Hant":{"blocks.aivoxassistant.name":"AI 語音助手","blocks.aivoxassistant.init":"初始引腳 RX:[RX] TX:[TX]","blocks.aivoxassistant.whenCommand":"當收到 [CMD] 指令時","blocks.aivoxassistant.argument":"指令參數 [ARG] 类型 [TYPE]","blocks.aivoxassistant.argumentInt":"整数","blocks.aivoxassistant.argumentFloat":"浮点数","blocks.aivoxassistant.argumentString":"字符串"}};var p="./assets/icon-jep655t2.svg";import{jsx as A}from"preact/jsx-runtime";T(f);var P={icon:p,name:A(b,{id:"blocks.aivoxassistant.name",defaultMessage:"AI Vox Assistant"}),blocks:h,menus:g,readme:_};export{P as default};
