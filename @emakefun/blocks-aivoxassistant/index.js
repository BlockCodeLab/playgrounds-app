import{addLocalesMessages as T,Text as b}from"@blockcode/core";import{Text as c}from"@blockcode/core";import{jsx as m}from"preact/jsx-runtime";var v=(r)=>r.editor==="@blockcode/gui-arduino",h=(r)=>[{id:"init",text:m(c,{id:"blocks.aivoxassistant.init",defaultMessage:"set pins RX:[RX] TX:[TX]"}),inputs:{RX:r.boardPins?{menu:r.boardPins.all}:{type:"positive_integer",defaultValue:2},TX:r.boardPins?{menu:r.boardPins.all}:{type:"positive_integer",defaultValue:3}},ino(t){let s=r.boardPins?t.getFieldValue("RX"):this.valueToCode(t,"RX",this.ORDER_NONE),e=r.boardPins?t.getFieldValue("TX"):this.valueToCode(t,"TX",this.ORDER_NONE);return this.definitions_.include_softwareserial="#include <SoftwareSerial.h>",this.definitions_.variable_aivoxAssistant=`SoftwareSerial aivoxAssistant(${s}, ${e});`,this.definitions_.setup_aivoxAssistant="aivoxAssistant.begin(115200);",""},mpy(t){let s=r.boardPins?t.getFieldValue("RX"):this.valueToCode(t,"RX",this.ORDER_NONE),e=r.boardPins?t.getFieldValue("TX"):this.valueToCode(t,"TX",this.ORDER_NONE);return this.definitions_.import_uart="from machine import UART",this.definitions_.aivox_assistant=`aivox_assistant = UART(1, baudrate=115200, rx=${s}, tx=${e})`,""}},"---",{id:"whenCommand",text:m(c,{id:"blocks.aivoxassistant.whenCommand",defaultMessage:"when receive [CMD] command"}),hat:!0,inputs:{CMD:{type:"string",defaultValue:"turn on led"}},ino(t){if(this.definitions_.include_regexp="#include <Regexp.h>",this.definitions_.variable_commandReg="MatchState cmdRe;",!this.definitions_.processAssistant){let n="";n+=`void processAssistant() {
`,n+=`  if (aivoxAssistant.available() == 0) return;
`,n+=`  String cmd = aivoxAssistant.readStringUntil('\\n');
`,n+=`  cmdRe.Target(cmd.c_str());
`,n+="}",this.definitions_.processAssistant=n,this.definitions_.declare_processAssistant="void processAssistant();",this.definitions_.loop_processAssistant="processAssistant();"}let s=this.createName("assistantCommand"),e=this.statementToCode(t)||"";this.definitions_[`declare_${s}`]=`void ${s}();`,this.definitions_[s]=`void ${s}() {
${e}}`;let d=this.valueToCode(t,"CMD",this.ORDER_NONE).replace(/\{\S+\}/g,"(%S+)").replace(/\s+/g,"%s+");this.definitions_.processAssistant=this.definitions_.processAssistant.replace(`;
}`,`;
  if (cmdRe.Match(${d}) > 0) return ${s}();
}`)},mpy(t){if(this.definitions_.import_re="import re",this.definitions_.assistant_matched="assistant_matched = None",!this.definitions_.assistant_received){let a="";a+=`@_tasks__.append
`,a+=`async def assistant_received():
`,a+=`  global assistant_matched
`,a+=`  while True:
`,a+=`    await asyncio.sleep_ms(5)
`,a+=`    if not aivox_assistant.any(): continue
`,a+=`    cmd = aivox_assistant.readline()
`,this.definitions_.assistant_received=a}let s=this.createName("assistant_flag");this.definitions_[s]=`${s} = asyncio.ThreadSafeFlag()`;let e=this.statementToCode(t)||"",i="";i+=`global assistant_matched
`,i+=`while True:
`,i+=`  await ${s}.wait()
`,i+=e;let d=this.valueToCode(t,"CMD",this.ORDER_NONE),n=this.getFunctionName(d);e=this.prefixLines(i,this.INDENT),e=this.addEventTrap(e,"assistant_callback"),i=`@_tasks__.append
`,i+=e,this.definitions_[n]=i;let o=d.replace(/\{\S+\}/g,"(\\S+)").replace(/\s+/g,"\\s+");i="",i+=`    assistant_matched = re.match(${o}, cmd)
`,i+=`    if assistant_matched: ${s}.set(); continue
`,this.definitions_.assistant_received+=i}},{id:"argument",text:m(c,{id:"blocks.aivoxassistant.argument",defaultMessage:"[TYPE] argument [ARG] of command"}),output:"string",inputs:{TYPE:{menu:v(r)?"ArduinoTypes":"Types"},ARG:{type:"string",defaultValue:"x"}},ino(t){let s=t.getRootBlock();if(t.parentBlock_===s)return"";let e=JSON.parse(this.valueToCode(t,"ARG",this.ORDER_NONE)),i=this.valueToCode(s,"CMD",this.ORDER_NONE),d=t.getFieldValue("TYPE");this.definitions_.include_regexp="#include <Regexp.h>",this.definitions_.variable_commandReg="MatchState cmdRe;";let n="";if(d!=="String")n=`.to${d.charAt(0).toUpperCase()}${d.slice(1)}()`;let o="";o+=`String getCommandArgument(uint8_t idx) {
`,o+=`  char arg[100];
`,o+=`  cmdRe.GetCapture(arg, idx);
`,o+=`  return String(arg)${n};
`,o+="}",this.definitions_.getCommandArgument=o,this.definitions_.declare_getCommandArgument="String getCommandArgument(uint8_t idx);";let a=0,u=[...i.matchAll(/\{(\w+)\}/g)];for(let l=0;l<u.length;l++)if(u[l][1]===e){a=l;break}return o=`getCommandArgument(${a})`,[o]},mpy(t){let s=t.getRootBlock();if(t.parentBlock_===s)return"";let e=JSON.parse(this.valueToCode(t,"ARG",this.ORDER_NONE)),i=this.valueToCode(s,"CMD",this.ORDER_NONE),d=t.getFieldValue("TYPE");this.definitions_.import_re="import re",this.definitions_.assistant_matched="assistant_matched = None";let n=0,o=[...i.matchAll(/\{(\w+)\}/g)];for(let l=0;l<o.length;l++)if(o[l][1]===e){n=l+1;break}let a="float";if(d!=="float")a=d.slice(0,3).toLowerCase();return[`${a}(${a==="str"?'""':0} if not assistant_matched else assistant_matched.group(${n}))`]}}],g={Types:{items:[[m(c,{id:"blocks.aivoxassistant.argumentInt",defaultMessage:"int"}),"int"],[m(c,{id:"blocks.aivoxassistant.argumentFloat",defaultMessage:"float"}),"float"],[m(c,{id:"blocks.aivoxassistant.argumentString",defaultMessage:"string"}),"String"]]},ArduinoTypes:{items:["int","float","String"]}};var _="///docs.emakefun.com/#/zh-cn/ph2.0_sensors/smart_module/ai_voice_assistant/ai_voice_assistant";var f={en:{"blocks.aivoxassistant.name":"AI Vox Assistant","blocks.aivoxassistant.init":"set pins RX:[RX] TX:[TX]","blocks.aivoxassistant.whenCommand":"when receive [CMD] command","blocks.aivoxassistant.argument":"[TYPE] argument [ARG] of command","blocks.aivoxassistant.argumentInt":"integer","blocks.aivoxassistant.argumentFloat":"float","blocks.aivoxassistant.argumentString":"string"},"zh-Hans":{"blocks.aivoxassistant.name":"AI 语音助手","blocks.aivoxassistant.init":"初始引脚 RX:[RX] TX:[TX]","blocks.aivoxassistant.whenCommand":"当收到 [CMD] 指令时","blocks.aivoxassistant.argument":"指令参数 [ARG] 类型 [TYPE]","blocks.aivoxassistant.argumentInt":"整数","blocks.aivoxassistant.argumentFloat":"浮点数","blocks.aivoxassistant.argumentString":"字符串"},"zh-Hant":{"blocks.aivoxassistant.name":"AI 語音助手","blocks.aivoxassistant.init":"初始引腳 RX:[RX] TX:[TX]","blocks.aivoxassistant.whenCommand":"當收到 [CMD] 指令時","blocks.aivoxassistant.argument":"指令參數 [ARG] 类型 [TYPE]","blocks.aivoxassistant.argumentInt":"整数","blocks.aivoxassistant.argumentFloat":"浮点数","blocks.aivoxassistant.argumentString":"字符串"}};var p="./assets/icon-jep655t2.svg";import{jsx as A}from"preact/jsx-runtime";T(f);var P={icon:p,name:A(b,{id:"blocks.aivoxassistant.name",defaultMessage:"AI Vox Assistant"}),blocks:h,menus:g,readme:_};export{P as default};
